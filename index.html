<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduCore - All-in-One Deep Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        :root {
            /* === å…¨å±€è®¾è®¡å˜é‡ === */
            --bg-body: #ffffff;
            --bg-sidebar: #f8fafc;
            --bg-card: #ffffff;
            --bg-hover: #f1f5f9;
            --bg-active: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            --border-hover: #cbd5e1;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            
            /* è§’è‰²ä¸»é¢˜è‰² (åŠ¨æ€åˆ‡æ¢) */
            --theme-color: #f97316; 
            --theme-bg: #fff7ed;
            --theme-hover: #ffedd5;
            --theme-border: #fecaca;

            /* åŠ¨ç”»æ›²çº¿ */
            --ease-spring: cubic-bezier(0.16, 1, 0.3, 1);
            --ease-in-out: cubic-bezier(0.4, 0, 0.2, 1);
            --ease-out: cubic-bezier(0.25, 1, 0.5, 1);
            
            /* é—´è·ç³»ç»Ÿ */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 12px;
            --space-lg: 16px;
            --space-xl: 20px;
            --space-2xl: 24px;
            --space-3xl: 32px;
            
            /* åœ†è§’ç³»ç»Ÿ */
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-2xl: 20px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        body { height: 100vh; background: var(--bg-body); color: var(--text-primary); overflow: hidden; position: relative; }

        /* =========================================
           åœºæ™¯ 1: é—¨æˆ·é¡µ (Portal)
           ========================================= */
        .portal-scene {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 20; background: #fff;
            transition: transform 0.6s var(--ease-spring), opacity 0.4s ease;
        }
        .portal-scene.hidden { opacity: 0; transform: scale(0.92) translateY(-40px); pointer-events: none; }

        .portal-header { text-align: center; margin-bottom: 50px; animation: fadeIn 0.8s ease; }
        .portal-logo { font-size: 48px; margin-bottom: 16px; display: inline-block; }
        .portal-title { font-size: 32px; font-weight: 600; color: #111; letter-spacing: -0.5px; }
        .portal-subtitle { font-size: 14px; color: #888; margin-top: 8px; }

        .role-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; max-width: 1000px; width: 100%; padding: 0 40px; }
        
        .role-card {
            background: #fff; 
            border: 1px solid #eee; 
            border-radius: 24px; 
            padding: 32px 24px; 
            text-align: center;
            cursor: pointer; 
            transition: all 0.4s var(--ease-spring); 
            opacity: 0; 
            animation: slideUp 0.6s var(--ease-spring) forwards;
            position: relative;
            overflow: hidden;
        }
        .role-card:nth-child(1) { animation-delay: 0.1s; } 
        .role-card:nth-child(2) { animation-delay: 0.15s; }
        .role-card:nth-child(3) { animation-delay: 0.2s; } 
        .role-card:nth-child(4) { animation-delay: 0.25s; }
        
        .role-card:hover { 
            transform: translateY(-12px) scale(1.02); 
            box-shadow: 0 24px 48px -12px rgba(0,0,0,0.12); 
            border-color: transparent; 
        }
        .role-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--theme-color);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        .role-card:hover::before {
            transform: scaleX(1);
        }
        .role-icon-lg {
            width: 64px; height: 64px; margin: 0 auto 24px auto; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 32px;
            transition: transform 0.3s var(--ease-spring);
        }
        .role-card:hover .role-icon-lg { transform: scale(1.1) rotate(5deg); }
        
        /* é—¨æˆ·é¡µç‰¹å®šé…è‰² */
        .card-teacher:hover { border-top: 4px solid #f97316; } .card-teacher .role-icon-lg { background: #fff7ed; color: #f97316; }
        .card-student:hover { border-top: 4px solid #3b82f6; } .card-student .role-icon-lg { background: #eff6ff; color: #3b82f6; }
        .card-parent:hover { border-top: 4px solid #10b981; } .card-parent .role-icon-lg { background: #ecfdf5; color: #10b981; }
        .card-admin:hover { border-top: 4px solid #ef4444; } .card-admin .role-icon-lg { background: #fef2f2; color: #ef4444; }

        /* =========================================
           åœºæ™¯ 2: å·¥ä½œå° (Workspace)
           ========================================= */
        .workspace-scene {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex;
            opacity: 0; transform: scale(0.98); pointer-events: none; transition: all 0.6s var(--ease-spring); background: #fff;
        }
        .workspace-scene.active { opacity: 1; transform: scale(1); pointer-events: auto; }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            height: 100vh;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            padding: 24px;
            display: flex;
            flex-direction: column;
            z-index: 10;
            transition: all 0.3s var(--ease-in-out);
        }
        .sidebar.collapsed {
            width: 60px;
            padding: 24px 12px;
        }
        /* ä¾§è¾¹æ æ”¶ç¼©æ—¶éšè—å“ç‰Œåç§°ï¼Œåªä¿ç•™logo */
        .sidebar.collapsed .app-brand {
            font-size: 0;
            justify-content: space-between;
            align-items: center;
        }
        .sidebar.collapsed .app-brand span:first-child {
            font-size: 24px;
        }

        /* é€šçŸ¥æŒ‰é’®æ ·å¼ä¼˜åŒ– */
        .nav-item .notif-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            min-width: 12px;
            height: 12px;
            padding: 0 4px;
            border-radius: 9999px;
            background: #ef4444;
            color: #fff;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: 800;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.35);
        }
        /* æœ‰é€šçŸ¥æ—¶æ˜¾ç¤ºæ°”æ³¡æé†’ */
        .nav-item .notif-badge:not(.hidden) {
            display: flex;
        }
        .sidebar.collapsed .user-badge {
            display: none;
        }
        .sidebar.collapsed .nav-item {
            justify-content: center;
            padding: 12px;
        }
        .sidebar.collapsed .nav-item span {
            display: none;
        }
        .sidebar.collapsed .nav-item .notif-badge:not(.hidden) {
            display: inline-block;
            font-size: 10px;
        }
        .main-content {
            margin-left: 260px;
            transition: margin-left 0.3s var(--ease-in-out);
        }
        .sidebar.collapsed + .main-content {
            margin-left: 60px;
        }
        .sidebar-toggle-internal {
            margin-left: auto;
            background: transparent;
            color: var(--text-primary);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s var(--ease-in-out);
        }
        .sidebar-toggle-internal:hover {
            background: var(--bg-hover);
            color: var(--theme-color);
            transform: scale(1.1);
        }
        .sidebar-toggle {
            display: none;
        }
        .app-brand {
            font-weight: 800;
            font-size: 20px;
            margin-bottom: 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            color: #111;
            width: 100%;
        }
        /* ä¿®å¤é€šçŸ¥æŒ‰é’®æ ·å¼ */
        .nav-item i {
            font-size: 18px;
            color: var(--text-secondary);
            transition: color 0.3s var(--ease-in-out);
        }
        .nav-item:hover i {
            color: var(--theme-color);
        }
        .nav-item.active i {
            color: var(--theme-color);
        }

        .user-badge {
            display: flex; align-items: center; gap: 12px; padding: 12px; background: #fff; border: 1px solid #e5e5e5; border-radius: 12px; margin-bottom: 32px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02);
        }
        .nav-item { 
            padding: 12px; 
            margin-bottom: 4px; 
            border-radius: 8px; 
            color: #555; 
            font-size: 14px; 
            font-weight: 500; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            cursor: pointer; 
            transition: all 0.2s ease; 
            position: relative;
            overflow: hidden;
        }
        .nav-item:hover { 
            background: #f0f0f0; 
            color: var(--theme-color); 
            transform: translateX(4px);
        }
        .nav-item.active { 
            background: #fff; 
            color: var(--theme-color); 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); 
            font-weight: 600;
            border-left: 3px solid var(--theme-color);
        }

        /* Main Content */
        .main-content { flex: 1; position: relative; display: flex; flex-direction: column; overflow: auto; }

        /* Hero Layer */
        .hero-layer {
            position: relative; 
            width: 100%; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            transition: all 0.5s var(--ease-spring); 
            padding: 40px 20px 20px; 
            z-index: 5;
            margin-bottom: 20px;
        }
        .hero-layer.hidden { opacity: 0; transform: translateY(-30px); pointer-events: none; }
        
        .hero-title { font-size: 36px; font-weight: 400; color: #111; margin-bottom: 40px; text-align: center; }
        
        .input-box {
            width: 100%;
            max-width: 760px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            padding: var(--space-xl) var(--space-2xl);
            box-shadow: var(--shadow-md);
            transition: all 0.3s var(--ease-in-out);
            position: relative;
        }
        .input-box:focus-within {
            box-shadow: var(--shadow-lg);
            border-color: var(--theme-color);
            transform: translateY(-2px);
        }
        textarea {
            font-size: 16px;
            line-height: 1.6;
            color: var(--text-primary);
            resize: none;
        }
        input, select {
            font-size: 14px;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 6px 10px;
            background: var(--bg-card);
            transition: all 0.3s var(--ease-in-out);
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--theme-color);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }
        
        .pill-container { display: flex; gap: var(--space-md); margin-top: var(--space-3xl); justify-content: center; }
        .pill {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: var(--space-md) var(--space-2xl);
            border-radius: 9999px;
            font-size: 14px;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            transition: all 0.3s var(--ease-in-out);
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        .pill:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--theme-color);
            color: var(--theme-color);
        }
        .pill:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }

        /* Chat Layer */
        .chat-layer {
            position: absolute; width: 100%; height: 100%; padding: 0; overflow-y: auto; display: none; background: #fff; scroll-behavior: smooth;
        }
        .chat-inner { max-width: 860px; margin: 0 auto; padding: var(--space-3xl) var(--space-2xl) var(--space-3xl) var(--space-2xl); }
        
        .message { margin-bottom: var(--space-3xl); opacity: 0; animation: slideUp 0.5s var(--ease-spring) forwards; }
        .msg-head { display: flex; align-items: center; gap: var(--space-sm); margin-bottom: var(--space-sm); font-size: 13px; font-weight: 600; color: var(--text-primary); }
        .msg-body { font-size: 12px; line-height: 1.7; color: var(--text-secondary); }
        .artifact-card .card-body { font-size: 12px; line-height: 1.6; }

        /* === äº¤ä»˜ç‰©å¡ç‰‡æ ·å¼ (Rich Artifacts) === */
        .thinking-box {
            background: #f9fafb; border-left: 3px solid #e5e7eb; border-radius: 0 8px 8px 0; padding: 16px; margin-bottom: 24px; font-family: 'SF Mono', 'Menlo', monospace; font-size: 13px; color: #6b7280;
        }
        .step { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; opacity: 0; animation: fadeIn 0.3s forwards; }
        .step.active { color: var(--theme-color); } .step.done { color: #10b981; }

        .artifact-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            margin-top: var(--space-2xl);
            overflow: hidden;
            animation: scaleIn 0.5s var(--ease-spring);
            transition: all 0.3s var(--ease-in-out);
        }
        .artifact-card:hover {
            box-shadow: var(--shadow-lg);
            border-color: var(--border-hover);
        }
        .card-header {
            padding: var(--space-lg) var(--space-xl);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-sidebar);
        }
        .card-body {
            padding: var(--space-xl);
        }
        .card-actions {
            padding: var(--space-lg) var(--space-xl);
            background: var(--bg-sidebar);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: var(--space-md);
        }
        
        .btn {
            padding: 8px 16px;
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s var(--ease-in-out);
            box-shadow: var(--shadow-sm);
        }
        .btn:hover {
            background: var(--bg-hover);
            border-color: var(--border-hover);
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }
        .btn:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }
        .btn-primary {
            background: var(--theme-color);
            border-color: var(--theme-color);
            color: #fff;
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
        }
        .btn-primary:hover {
            opacity: 0.95;
            box-shadow: 0 6px 16px rgba(249, 115, 22, 0.4);
            transform: translateY(-2px);
        }
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
        }

        /* === æ·±åº¦åœºæ™¯ä¸“ç”¨ç»„ä»¶æ ·å¼ === */
        /* é€šç”¨æ ‡ç­¾ */
        .tag { font-size: 11px; padding: 3px 8px; border-radius: 4px; font-weight: 700; text-transform: uppercase; }
        .tag-green { background: #d1fae5; color: #047857; }
        .tag-orange { background: #ffedd5; color: #c2410c; }
        .tag-red { background: #fee2e2; color: #b91c1c; }
        .tag-blue { background: #dbeafe; color: #1d4ed8; }

        /* æ•™æ¡ˆ/æ—¶é—´è½´ */
        .timeline { display: flex; gap: 12px; overflow-x: auto; padding: 4px; }
        .t-box { flex: 1; min-width: 100px; background: #fafafa; border: 1px solid #eee; padding: 12px; text-align: center; border-radius: 8px; font-size: 13px; transition: 0.2s; }
        .t-box:hover { border-color: var(--theme-color); background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

        /* ä½œä¸šåˆ†æ - æŸ±çŠ¶å›¾æ¨¡æ‹Ÿ */
        .bar-chart { display: flex; align-items: flex-end; height: 100px; gap: 8px; padding-top: 20px; }
        .bar { flex: 1; background: var(--theme-color); opacity: 0.8; border-radius: 4px 4px 0 0; position: relative; }
        .bar:hover { opacity: 1; }
        .bar span { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 11px; color: #666; }

        /* é”™é¢˜è¯Šæ–­ - å¯¹æ¯”å¡ç‰‡ */
        .mistake-split { display: flex; gap: 20px; }
        .mistake-left { flex: 1; background: #fef2f2; padding: 15px; border-radius: 8px; border: 1px solid #fee2e2; }
        .mistake-right { flex: 1; background: #ecfdf5; padding: 15px; border-radius: 8px; border: 1px solid #d1fae5; }

        /* è‹±è¯­å¯¹è¯ - æ°”æ³¡ */
        .chat-bubble { padding: 10px 14px; border-radius: 12px; font-size: 12px; margin-bottom: 8px; max-width: 80%; }
        .bubble-ai { background: #f3f4f6; color: #333; border-bottom-left-radius: 2px; }
        .bubble-user { background: var(--theme-bg); color: var(--theme-color); margin-left: auto; border-bottom-right-radius: 2px; border: 1px solid var(--theme-color); }

        /* ç»Ÿè®¡æ ¼å­ */
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 15px;}
        .stat-box { background: #f9fafb; padding: 12px; border-radius: 8px; text-align: center; border: 1px solid #eee; }
        .stat-val { font-size: 20px; font-weight: 700; color: #111; }
        .stat-lbl { font-size: 12px; color: #666; margin-top: 4px; }

        /* é¢„è­¦/åˆ—è¡¨é¡¹ */
        .alert-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f3f4f6; }
        .alert-badge { padding: 4px 8px; border-radius: 100px; font-size: 11px; font-weight: 700; }
        .bg-red { background: #fef2f2; color: #ef4444; }
        
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #f3f4f6; font-size: 12px; }

        /* åŠ¨ç”»å…³é”®å¸§ */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.96); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
        
        /* ç»Ÿä¸€çš„è¿‡æ¸¡æ•ˆæœ */
        .nav-item, .role-card, .todo-item, .todo-card, .kpi, .panel, .artifact-card, .btn, .mini-btn, .pill {
            transition: all 0.3s var(--ease-in-out);
        }
        
        /* å¢å¼ºçš„åŠ¨ç”»æ•ˆæœ */
        .message {
            animation: slideUp 0.5s var(--ease-spring) forwards;
        }
        .artifact-card {
            animation: scaleIn 0.6s var(--ease-spring) forwards;
        }
        .role-card {
            animation: slideUp 0.6s var(--ease-spring) forwards;
        }
        .toast {
            animation: slideUp 0.3s var(--ease-spring) forwards;
        }

    
        /* =========================================
           ä»»åŠ¡å¾…åŠ / è§’è‰²åˆ‡æ¢ (é“¾è·¯Aå¢å¼º)
        ========================================= */
        .role-switch { margin: 14px 0 10px; padding: 10px; border: 1px solid var(--border-color); border-radius: 12px; background:#fff; }
        .rs-title { font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; }
        .rs-buttons { display:flex; flex-wrap:wrap; gap:8px; }
        .rs-btn { padding: 7px 10px; border-radius: 10px; border: 1px solid var(--border-color); background: #fff; cursor: pointer; font-size: 12px; color: var(--text-primary); transition: 0.2s; }
        .rs-btn:hover { border-color: var(--theme-color); color: var(--theme-color); }

        .todo-sidebar { margin-top: 10px; padding: 10px; border: 1px solid var(--border-color); border-radius: 12px; background:#fff; }
        .todo-title { font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; display:flex; justify-content:space-between; align-items:center; }
        .todo-list { display:flex; flex-direction:column; gap:8px; }
        .todo-item { border: 1px solid var(--border-color); border-radius: 12px; padding: 10px; background:#fafafa; cursor:pointer; transition: 0.2s; }
        .todo-item:hover { border-color: var(--theme-color); background: #fff; }
        .todo-item-top { display:flex; justify-content:space-between; gap:10px; align-items:center; }
        .todo-item-title { font-weight: 650; font-size: 12px; color: var(--text-primary); line-height:1.2; }
        .todo-item-tag { font-size: 11px; color:#6b7280; background:#f3f4f6; padding: 3px 8px; border-radius: 999px; }
        .todo-item-desc { margin-top: 6px; font-size: 11px; color: var(--text-secondary); line-height:1.35; }

        .todo-strip { margin: 12px 0 14px; padding: 12px; border: 1px dashed rgba(17,24,39,0.15); border-radius: 16px; background: rgba(255,255,255,0.85); }
        .todo-strip-head { display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px; }
        .todo-strip-title { font-size: 13px; font-weight: 650; }
        .todo-strip-sub { font-size: 12px; color: var(--text-secondary); }
        .todo-strip-cards { display:flex; gap:10px; flex-wrap:wrap; }
        .todo-card { border: 1px solid var(--border-color); border-radius: 14px; padding: 10px 12px; background:#fff; min-width: 220px; max-width: 340px; cursor:pointer; transition:0.2s; }
        .todo-card:hover { border-color: var(--theme-color); transform: translateY(-1px); }
        .todo-card-title { font-weight: 650; font-size: 13px; }
        .todo-card-desc { margin-top: 6px; font-size: 12px; color: var(--text-secondary); line-height: 1.35; }
        .todo-card-cta { margin-top: 10px; display:flex; gap:8px; }
        .todo-card-cta .mini-btn { padding: 6px 10px; border-radius: 10px; border: 1px solid var(--border-color); background: #fff; cursor:pointer; font-size: 12px; }
        .todo-card-cta .mini-btn.primary { border-color: var(--theme-color); color: var(--theme-color); }

        .toast-stack { position: fixed; right: 18px; top: 18px; z-index: 9999; display:flex; flex-direction:column; gap:10px; }
        .toast { min-width: 260px; max-width: 360px; border: 1px solid var(--border-color); border-left: 4px solid var(--theme-color); border-radius: 14px; padding: 12px 12px; background:#fff; box-shadow: 0 12px 30px rgba(0,0,0,0.08); animation: toastIn 0.25s var(--ease-spring); }
        .toast-title { font-weight: 650; font-size: 13px; }
        .toast-desc { margin-top: 6px; font-size: 12px; color: var(--text-secondary); line-height:1.35; }
        .toast-actions { margin-top: 10px; display:flex; gap:8px; }
        .toast-actions button { padding: 6px 10px; border-radius: 10px; border: 1px solid var(--border-color); background: #fff; cursor:pointer; font-size: 12px; }
        .toast-actions button.primary { border-color: var(--theme-color); color: var(--theme-color); }
        @keyframes toastIn { from { transform: translateY(-6px); opacity:0;} to { transform: translateY(0); opacity:1; } }

    
        /* ===== Role Dashboard (æ›´è´´è¿‘çœŸå®) ===== */
        .role-dashboard { width: 100%; max-width: 960px; margin: 0 auto 18px; }
        .ctx-bar { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 12px; border:1px solid #e5e7eb; border-radius: 14px; background:#fff; box-shadow: 0 4px 12px rgba(0,0,0,0.04); }
        .ctx-left { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
        .ctx-pill { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#f9fafb; border:1px solid #e5e7eb; font-size:12px; color:#374151; }
        .ctx-pill select { border:none; background:transparent; font-size:12px; outline:none; color:#111827; }
        .ctx-right { display:flex; align-items:center; gap:10px; }
        .kpi-grid { display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:16px; margin-top:16px; height: 120px; }
        /* å¹³æ¿è®¾å¤‡ */
        @media (max-width: 980px) {
            .kpi-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
            .dash-grid {
                grid-template-columns: 1fr;
            }
            .below-panels {
                grid-template-columns: 1fr;
            }
        }
        .kpi {
            padding: var(--space-xl);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            background: var(--bg-card);
            box-shadow: var(--shadow-md);
            transition: all 0.3s var(--ease-in-out);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            height: 100%;
            backdrop-filter: blur(10px);
        }
        .kpi::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--theme-color);
            transform: scaleX(0);
            transition: transform 0.3s var(--ease-in-out);
        }
        .kpi:hover {
            box-shadow: var(--shadow-xl);
            border-color: var(--border-hover);
            transform: translateY(-4px);
        }
        .kpi:hover::before {
            transform: scaleX(1);
        }
        .kpi .kpi-val{ 
            font-size:24px; 
            font-weight:700; 
            color:#111827; 
            margin-bottom:4px;
        }
        .kpi .kpi-lbl{ 
            font-size:12px; 
            color:#6b7280; 
            line-height:1.4;
        }
        .dash-grid { display:grid; grid-template-columns: 1.2fr 0.8fr; gap:10px; margin-top:10px; }

        .panel { 
            border: 1px solid var(--border-color); 
            border-radius: var(--radius-xl); 
            background: var(--bg-card); 
            overflow: hidden; 
            box-shadow: var(--shadow-md);
            transition: all 0.3s var(--ease-in-out);
            min-height: 240px;
            display: flex;
            flex-direction: column;
        }
        .panel-bd {
            flex: 1;
            padding:20px;
            display: flex;
            flex-direction: column;
        }
        .below-panels {
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
            margin-top: 12px;
        }

        .panel:hover { 
            box-shadow: var(--shadow-md); 
            border-color: #e5e7eb;
        }
        .panel-hd { 
            padding: var(--space-lg) var(--space-xl); 
            border-bottom: 1px solid var(--border-color); 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            font-size: 14px; 
            color: var(--text-primary); 
            font-weight: 700; 
            background: var(--bg-sidebar);
        }
        .panel-bd { 
            padding: var(--space-xl); 
        }
        .item { 
            display:flex; 
            gap:16px; 
            padding:16px 0; 
            border-bottom:1px solid #f5f5f5; 
            align-items:flex-start;
            transition: all 0.2s var(--ease-in-out);
        }
        .item:hover { 
            transform: translateX(8px);
        }
        .item:last-child { border-bottom: none; }
        .item .meta{ flex:1; }
        .item .title{ 
            font-size:14px; 
            color:#111827; 
            font-weight:650; 
            margin-bottom:4px;
        }
        .item .sub{ 
            font-size:12px; 
            color:#6b7280; 
            line-height:1.5;
        }
        .mini-btn {
            padding: 7px 12px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s var(--ease-in-out);
            font-weight: 500;
            box-shadow: var(--shadow-sm);
        }
        .mini-btn:hover {
            background: var(--bg-hover);
            border-color: var(--border-hover);
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }
        .mini-btn:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }
        .mini-btn.primary {
            border-color: var(--theme-color);
            background: var(--theme-color);
            color: #fff;
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
        }
        .mini-btn.primary:hover {
            opacity: 0.95;
            box-shadow: 0 6px 16px rgba(249, 115, 22, 0.4);
            transform: translateY(-2px);
        }
        .mini-btn.primary:active {
            transform: translateY(0);
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
        }
        .below-panels { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 16px; 
            margin-top: 16px; 
        }


        /* ===== Modal (é…ç½®æ¨é€) ===== */
        .modal-overlay{ position:fixed; inset:0; background: rgba(17,24,39,0.55); display:none; align-items:center; justify-content:center; z-index: 9999; padding: 18px; }
        .modal{ width:100%; max-width: 720px; background:#fff; border-radius: 18px; border:1px solid #e5e7eb; box-shadow: 0 30px 80px rgba(0,0,0,0.25); overflow:hidden; }
        .modal-hd{ padding:14px 16px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #eef2f7; }
        .modal-title{ font-size:14px; font-weight:700; color:#111827; }
        .modal-bd{ padding:14px 16px; }
        .modal-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
        /* ç§»åŠ¨è®¾å¤‡ */
        @media (max-width: 760px) {
            .modal-grid {
                grid-template-columns: 1fr;
            }
            .role-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            .hero-title {
                font-size: 28px;
                margin-bottom: 24px;
            }
            .input-box {
                padding: var(--space-lg) var(--space-xl);
            }
            .pill-container {
                flex-wrap: wrap;
                gap: 8px;
                margin-top: 24px;
            }
            .pill {
                padding: var(--space-sm) var(--space-lg);
            }
            .main-content {
                padding: 0 16px;
            }
        }
        
        /* å°å±ç§»åŠ¨è®¾å¤‡ */
        @media (max-width: 480px) {
            .hero-title {
                font-size: 24px;
            }
            .input-box {
                padding: var(--space-md) var(--space-lg);
            }
            .card-header,
            .card-body,
            .card-actions,
            .panel-hd,
            .panel-bd {
                padding: var(--space-md);
            }
        }
        .pick{ border:1px solid #e5e7eb; border-radius: 14px; padding: 12px; background:#fafafa; }
        .pick .pick-h{ font-size:13px; font-weight:650; color:#111827; display:flex; align-items:center; justify-content:space-between; }
        .pick ul{ list-style:none; padding-left:0; margin:10px 0 0; display:flex; flex-direction:column; gap:8px; }
        .pick li{ display:flex; align-items:center; justify-content:space-between; gap:10px; background:#fff; border:1px solid #eef2f7; border-radius:12px; padding:8px 10px; }
        .modal-ft{ padding:14px 16px; border-top:1px solid #eef2f7; display:flex; justify-content:flex-end; gap:10px; }
        .btn-ghost{ padding:10px 12px; border-radius: 12px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; }
        .btn-solid{ padding:10px 12px; border-radius: 12px; border:1px solid #111827; background:#111827; color:#fff; cursor:pointer; }

        .seg-row{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin:10px 0 14px; }
        .seg{ display:flex; background:#f3f4f6; padding:4px; border-radius:14px; border:1px solid #e5e7eb; }
        .seg-btn{ border:0; background:transparent; padding:8px 12px; border-radius:12px; font-size:12px; color:#374151; cursor:pointer; font-weight:650; }
        .seg-btn.active{ background:#111827; color:#fff; box-shadow:0 6px 18px rgba(17,24,39,0.12); }
        #qPickList li .qStem{ display:block; font-size:12px; color:#6b7280; line-height:1.35; margin-top:4px; }


        /* ===== Top Context Bar (does not affect center chat box) ===== */
        .top-context { padding: 14px 18px 0; }
        .top-context .ctx-bar {
            max-width: 960px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .ctx-right {
            margin-left: auto;
        }
        .top-context .kpi-grid { max-width: 960px; margin: 10px auto 0; }

        /* ===== Manus-style panels under dialog ===== */
        .role-dashboard { 
            width: 100%; 
            max-width: 960px; 
            margin: 10px auto 20px; 
            position: relative; 
            z-index: 1; 
        }




        /* ===== Notification button (top-right) ===== */
        .notif-btn{
            position:fixed; top:14px; right:18px;
            display:flex; align-items:center; gap:8px;
            padding:8px 10px; border-radius:14px; border:1px solid #e5e7eb;
            background:#fff; cursor:pointer; z-index:45;
            box-shadow: 0 10px 24px rgba(0,0,0,0.08);
            font-size:13px; color:#111827; font-weight:650;
        }
        
        /* ç§»é™¤å³ä¾§marginï¼Œç¡®ä¿ä¸Šä¸‹æ–‡æ å±…ä¸­ */
        .top-context {
            padding: 14px 18px 0;
            margin-right: 0;
        }
        .notif-btn i{ font-size:18px; }
        .notif-label{ line-height:1; }
        .notif-badge{
            margin-left:2px;
            min-width:18px; height:18px; padding:0 6px;
            border-radius:999px;
            background:#ef4444; color:#fff;
            display:inline-flex; align-items:center; justify-content:center;
            font-size:11px; font-weight:800;
            box-shadow: 0 6px 16px rgba(239,68,68,0.35);
        }

        /* ===== Right Todo Popover ===== */
        .todo-popover { 
            position: fixed; 
            right: 20px; 
            top: 80px; 
            width: 280px; 
            max-height: 300px; 
            background: #fff; 
            border: 1px solid #e5e7eb; 
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.12); 
            overflow: hidden; 
            z-index: 1000; 
        }
        .todo-popover.hidden { display: none; }
        .todo-popover-hd { 
            display:flex; 
            align-items:center; 
            justify-content:space-between; 
            padding: 12px 16px 10px; 
            border-bottom: 1px solid #f3f4f6; 
        }
        .todo-popover-title { 
            font-size: 13px; 
            font-weight: 700; 
            color:#111827; 
        }
        .todo-popover-bd { 
            padding: 10px 16px 12px; 
            overflow:auto; 
            max-height: calc(400px - 52px); 
            font-size: 12px;
        }
        .todo-item {
            font-size: 12px;
        }
        .todo-item-title {
            font-size: 12px;
            font-weight: 600;
        }
        .todo-item-desc {
            font-size: 11px;
        }
        .todo-fab { position: absolute; right: 22px; bottom: 22px; z-index: 31; display:inline-flex; align-items:center; gap:8px; padding: 10px 12px; border-radius: 999px;
                    border: 1px solid #e5e7eb; background:#fff; box-shadow: 0 10px 30px rgba(0,0,0,0.10); cursor:pointer; }
        .todo-fab.hidden { display:none; }
        .todo-fab span { display:inline-flex; min-width: 18px; height: 18px; padding: 0 6px; border-radius: 999px; background: var(--theme-bg); color: var(--theme-color); font-weight:700; font-size: 12px;
                         align-items:center; justify-content:center; border: 1px solid rgba(0,0,0,0.06); }

        /* Keep hero dialog centered */
        .hero-layer { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            padding: 24px 18px; 
            gap: 14px; 
            background: #fff; 
            z-index: 2; 
            position: relative;
        }
        

        .hero-title { text-align: center; }

</style>
</head>
<body>

    <div class="portal-scene" id="portalScene">
        <div class="portal-header">
            <div class="portal-logo">ğŸ”¥</div>
            <div class="portal-title">EduCore Space</div>
            <div class="portal-subtitle">AI é©±åŠ¨çš„å…¨åœºæ™¯æ•™è‚²æ“ä½œç³»ç»Ÿ</div>
        </div>

        <div class="role-grid">
            <div class="role-card card-teacher" onclick="enterWorkspace('teacher')">
                <div class="role-icon-lg"><i class="ri-briefcase-line"></i></div>
                <div style="font-weight:600; font-size:18px;">æ•™å¸ˆå·¥ä½œå°</div>
                <div style="font-size:13px; color:#888; margin-top:8px;">AI æ•™æ¡ˆ Â· ä½œä¸š Â· è®ºæ–‡</div>
            </div>
            <div class="role-card card-student" onclick="enterWorkspace('student')">
                <div class="role-icon-lg"><i class="ri-graduation-cap-line"></i></div>
                <div style="font-weight:600; font-size:18px;">å­¦ç”Ÿå­¦ä¹ èˆ±</div>
                <div style="font-size:13px; color:#888; margin-top:8px;">é”™é¢˜ Â· é¢„ä¹  Â· é™ªç»ƒ</div>
            </div>
            <div class="role-card card-parent" onclick="enterWorkspace('parent')">
                <div class="role-icon-lg"><i class="ri-home-heart-line"></i></div>
                <div style="font-weight:600; font-size:18px;">å®¶æ ¡äº’é€š</div>
                <div style="font-size:13px; color:#888; margin-top:8px;">å‘¨æŠ¥ Â· äº’é€š Â· æ•™è‚²</div>
            </div>
            <div class="role-card card-admin" onclick="enterWorkspace('admin')">
                <div class="role-icon-lg"><i class="ri-government-line"></i></div>
                <div style="font-weight:600; font-size:18px;">ç®¡ç†é©¾é©¶èˆ±</div>
                <div style="font-size:13px; color:#888; margin-top:8px;">å®‰å…¨ Â· å­¦æƒ… Â· é£Ÿå ‚</div>
            </div>
        </div>
    </div>


    <div class="workspace-scene" id="workspaceScene">
        
        <div class="sidebar">
            <div class="app-brand">
                <span style="font-size:24px;">ğŸ”¥</span> EduCore
                <button class="sidebar-toggle-internal" onclick="toggleSidebar()">
                    <i class="ri-menu-line"></i>
                </button>
            </div>

            <div class="user-badge" id="userBadge"></div>

            <div class="nav-item active" onclick="newChat()"><i class="ri-chat-3-line"></i> <span>æ–°å»ºå¯¹è¯</span></div>
            <div class="nav-item"><i class="ri-history-line"></i> <span>å†å²ä¼šè¯</span></div>
            <div class="nav-item"><i class="ri-book-open-line"></i> <span>çŸ¥è¯†åº“</span></div>
            <div class="nav-item"><i class="ri-folder-3-line"></i> <span>æˆ‘çš„æ–‡ä»¶</span></div>
            <div class="nav-item" onclick="toggleTodoPopover()">
                <i class="ri-notification-3-line"></i> <span>é€šçŸ¥</span>
                <span class="notif-badge hidden" id="notifBadge"></span>
            </div>

            <div class="nav-item" style="margin-top:auto; color:#999;" onclick="exitWorkspace()">
                <i class="ri-logout-box-line"></i> <span>åˆ‡æ¢èº«ä»½</span>
            </div>
        </div>

        <div class="main-content">
            <button class="sidebar-toggle" onclick="toggleSidebar()">
                <i class="ri-menu-line"></i>
            </button>
            <div class="top-context" id="topContextBar"></div>

            
            <div class="hero-layer" id="heroLayer">
                <div class="hero-title" id="heroGreeting">Hello</div>

                <div class="input-box">
                    <textarea id="mainInput" style="width:100%; border:none; outline:none; font-size:16px; resize:none; min-height:28px;" placeholder="è¾“å…¥éœ€æ±‚..."></textarea>
                    <div style="display:flex; justify-content:space-between; margin-top:16px; border-top:1px solid #f9f9f9; padding-top:12px;">
                        <div style="display:flex; gap:12px; color:#9ca3af;">
                            <i class="ri-attachment-2 cursor-pointer"></i>
                            <i class="ri-image-line cursor-pointer"></i>
                        </div>
                        <i class="ri-arrow-up-circle-fill" style="font-size:32px; color:#e5e5e5; cursor:pointer; transition:0.2s;" onmouseover="this.style.color='#111'" onmouseout="this.style.color='#e5e5e5'" onclick="handleInput()"></i>
                    </div>
                </div>

                <div class="pill-container" id="pillContainer">
                </div>
            </div>

            <div class="chat-layer" id="chatLayer">
                <div class="chat-inner" id="chatContainer">
                </div>
            </div>

            <div class="role-dashboard" id="roleDashboard" style="display:none;"></div>

            <!-- Right Todo Popover (Manus-style) -->
            <div class="todo-popover hidden" id="todoPopover">
                <div class="todo-popover-hd">
                    <div class="todo-popover-title">é€šçŸ¥</div>
                    <div class="todo-popover-actions">
                        <button class="mini-btn" onclick="snoozeTodo()">ç¨å</button>
                    </div>
                </div>
                <div class="todo-popover-bd" id="todoPopoverList"></div>
            </div>
<div class="toast-stack" id="toastStack"></div>
        </div>
    </div>

    <script>
        // === 1. æ•°æ®é…ç½® (åŒ…å«æ‰€æœ‰åœºæ™¯çš„é¢„è®¾) ===
        const CONFIG = {
            teacher: {
                name: "æ—è€å¸ˆ", role: "æ•°å­¦æ•™ç ”ç»„", color: "#f97316", bg: "#fff7ed",
                greeting: "æ—è€å¸ˆï¼Œä»Šå¤©é‡ç‚¹å¤„ç†ä»€ä¹ˆï¼Ÿ",
                placeholder: "è¾“å…¥æŒ‡ä»¤ï¼Œå¦‚ï¼šç”Ÿæˆã€Šå‹¾è‚¡å®šç†ã€‹æ•™æ¡ˆ...",
                pills: [
                    { icon: "ri-file-text-line", text: "AI æ•™æ¡ˆç”Ÿæˆ", action: "teacher_lesson" },
                    { icon: "ri-pie-chart-line", text: "ä½œä¸šæ•°æ®åˆ†æ", action: "teacher_homework" },
                    { icon: "ri-article-line", text: "AI æ•™å­¦è®ºæ–‡è¾…åŠ©", action: "teacher_paper" }
                ]
            },
            student: {
                name: "æåŒå­¦", role: "åˆäºŒ(3)ç­", color: "#3b82f6", bg: "#eff6ff",
                greeting: "æåŒå­¦ï¼Œå¼€å§‹ä»Šå¤©çš„è¿›æ­¥ä¹‹æ—…ï¼",
                placeholder: "æ‹ç…§ä¸Šä¼ é”™é¢˜ï¼Œæˆ–å¼€å§‹è‹±è¯­å¯¹è¯...",
                pills: [
                    { icon: "ri-camera-lens-line", text: "é”™é¢˜æ™ºèƒ½è¯Šæ–­", action: "student_mistake" },
                    { icon: "ri-translate-2", text: "è‹±è¯­å£è¯­é™ªç»ƒ", action: "student_english" },
                    { icon: "ri-book-read-line", text: "åˆ†å­¦æ®µé¢„ä¹ è®¡åˆ’", action: "student_preview" }
                ]
            },
            parent: {
                name: "ææ˜å®¶é•¿", role: "å®¶é•¿ç«¯", color: "#10b981", bg: "#ecfdf5",
                greeting: "æ‚¨å¥½ï¼Œäº†è§£å­©å­æˆé•¿çš„æ¯ä¸€åˆ»ã€‚",
                placeholder: "æŸ¥è¯¢å‘¨æŠ¥ï¼Œæˆ–äº†è§£åœ¨æ ¡æƒ…å†µ...",
                pills: [
                    { icon: "ri-line-chart-line", text: "æˆé•¿å‘¨æŠ¥", action: "parent_report" },
                    { icon: "ri-message-2-line", text: "å®¶æ ¡ AI äº’é€š", action: "parent_connect" },
                    { icon: "ri-parent-line", text: "å®¶åº­æ•™è‚²æŒ‡å¯¼", action: "parent_edu" }
                ]
            },
            admin: {
                name: "æ•™åŠ¡ä¸»ä»»", role: "ç®¡ç†ç«¯", color: "#ef4444", bg: "#fef2f2",
                greeting: "ç®¡ç†é©¾é©¶èˆ±è¿è¡Œä¸­ã€‚",
                placeholder: "æŸ¥è¯¢æ ¡å›­å®‰å…¨æˆ–å­¦æƒ…è¿½è¸ª...",
                pills: [
                    { icon: "ri-alarm-warning-line", text: "æ ¡å›­å®‰å…¨ç›‘æµ‹", action: "admin_safety" },
                    { icon: "ri-calendar-event-line", text: "å­¦æƒ…è¿½è¸ª", action: "admin_activity" },
                    { icon: "ri-restaurant-line", text: "é£Ÿå ‚æ™ºèƒ½ç®¡ç†", action: "admin_canteen" }
                ]
            }
        };

        let currentRole = null;

        // === 1.1 é“¾è·¯Aï¼šä»»åŠ¡ä¸ä¸Šä¸‹æ–‡çŠ¶æ€ ===
        const APP_STATE = {
            tasks: { teacher: [], student: [], parent: [], admin: [] },
            todoSnoozed: false,
            adminGranularity: 'week',
            // roster/children for multi-entity demo realism
            roster: [
                { id: "s01", name: "ææ˜", className: "åˆäºŒ(3)ç­" },
                { id: "s02", name: "å¼ ä¼Ÿ", className: "åˆäºŒ(3)ç­" },
                { id: "s03", name: "ç‹èŠ³", className: "åˆäºŒ(3)ç­" },
                { id: "s04", name: "é™ˆæµ©", className: "åˆäºŒ(3)ç­" }
            ],
            currentStudentId: "s01",
            children: [
                { id: "c01", name: "ææ˜", className: "åˆäºŒ(3)ç­" }
            ],
            currentChildId: "c01",
            pendingCtx: null,
            lastHomeworkInsight: null,
            lastStudentResult: null,
            adminAnalytics: {
                // 7å¤©è¶‹åŠ¿ï¼šè–„å¼±ç‚¹çƒ­åº¦ï¼ˆç”¨äºé©¾é©¶èˆ±è¶‹åŠ¿å±•ç¤ºï¼‰
                weakPointTrend: {
                    "ä¸€æ¬¡å‡½æ•°æˆªè·": [8,9,10,12,13,14,15],
                    "ç”¨ç‚¹æ±‚ä¸€æ¬¡å‡½æ•°è§£æå¼": [5,5,6,7,7,8,8],
                    "ä¸€æ¬¡å‡½æ•°å›¾åƒä¸æˆªè·å…³ç³»": [4,4,5,6,6,6,7]
                },
                // ç­çº§å¯¹æ¯”ï¼šå®Œæˆç‡/æŒæ¡ç‡ï¼ˆæ¼”ç¤ºï¼‰
                classCompare: [
                    { className: "åˆäºŒ(1)ç­", completion: 0.78, mastery: 0.74 },
                    { className: "åˆäºŒ(2)ç­", completion: 0.71, mastery: 0.69 },
                    { className: "åˆäºŒ(3)ç­", completion: 0.65, mastery: 0.66 },
                    { className: "åˆäºŒ(4)ç­", completion: 0.73, mastery: 0.71 }
                ]
            }};

        function uid(prefix="t") {
            return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
        }

        function showToast(title, desc, actions=[]) {
            const stack = document.getElementById('toastStack');
            if (!stack) return;
            const id = uid("toast");
            const el = document.createElement('div');
            el.className = 'toast';
            el.id = id;
            el.innerHTML = `
                <div class="toast-title">${title}</div>
                <div class="toast-desc">${desc || ""}</div>
                <div class="toast-actions" id="${id}_actions"></div>
            `;
            stack.appendChild(el);
            const actionBox = document.getElementById(id + "_actions");
            actions.forEach(a => {
                const btn = document.createElement('button');
                btn.className = a.primary ? "primary" : "";
                btn.innerText = a.label;
                btn.onclick = () => { try { a.onClick && a.onClick(); } finally { removeToast(id); } };
                actionBox.appendChild(btn);
            });
            setTimeout(() => removeToast(id), 4200);
        }

        function removeToast(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function addTask(role, task) {
            APP_STATE.tasks[role] = APP_STATE.tasks[role] || [];
            APP_STATE.tasks[role].unshift(task);
            renderTodos();
        }

        function completeTask(role, taskId) {
            const list = APP_STATE.tasks[role] || [];
            const t = list.find(x => x.id === taskId);
            if (t) t.status = "done";
            renderTodos();
        }

        function getActiveTasks(role) {
            let list = (APP_STATE.tasks[role] || []).filter(t => t.status !== "done");
            if (role === "student") {
                const sid = APP_STATE.currentStudentId;
                list = list.filter(t => !t.studentId || t.studentId === sid);
            }
            if (role === "parent") {
                const cid = APP_STATE.currentChildId;
                list = list.filter(t => !t.childId || t.childId === cid);
            }
            return list;
        }

        
        function renderTodos() {
            const role = currentRole;
            if (!role) return;

            const active = getActiveTasks(role);

            // Right popover list
            const listEl = document.getElementById('todoPopoverList');
            if (listEl) {
                listEl.innerHTML = "";
                if (active.length === 0) {
                    listEl.innerHTML = `<div style="font-size:12px; color:#9ca3af; padding:6px 2px;">æš‚æ— å¾…åŠ</div>`;
                } else {
                    active.slice(0, 10).forEach(t => {
                        const item = document.createElement('div');
                        item.className = 'todo-item';
                        item.onclick = () => openTask(t.id);
                        item.innerHTML = `
                            <div class="todo-item-top">
                                <div class="todo-item-title">${t.title}</div>
                                <div class="todo-item-badge">${t.badge||"å¾…å¤„ç†"}</div>
                            </div>
                            <div class="todo-item-sub">${t.desc||""}</div>
                        `;
                        listEl.appendChild(item);
                    });
                }
            }

            // Notification badge
            const badgeEl = document.getElementById("notifBadge");
            if (badgeEl){
                const n = active.length;
                if (n > 0){
                    badgeEl.textContent = String(n);
                    badgeEl.classList.remove('hidden');
                    badgeEl.style.display = "flex";
                } else {
                    badgeEl.textContent = "";
                    badgeEl.classList.add('hidden');
                    badgeEl.style.display = "none";
                }
            }

            // Default behavior: if has tasks and not snoozed, show popover; else hide
            const pop = document.getElementById('todoPopover');
            if (pop){
                if (active.length > 0 && !APP_STATE.todoSnoozed){
                    pop.classList.remove('hidden');
                } else {
                    pop.classList.add('hidden');
                }
            }
        }


        function dismissTask(taskId) {
            // ç®€å•ç­–ç•¥ï¼šæŠŠä»»åŠ¡ç§»åˆ°æœ«å°¾
            const role = currentRole;
            const list = APP_STATE.tasks[role] || [];
            const idx = list.findIndex(x => x.id === taskId);
            if (idx >= 0) {
                const [t] = list.splice(idx, 1);
                list.push(t);
                renderTodos();
            }
        }

        function findTask(taskId) {
            const list = APP_STATE.tasks[currentRole] || [];
            return list.find(t => t.id === taskId);
        }

        renderRoleDashboard();

        function openTask(taskId) {
            const t = findTask(taskId);
            if (!t) return;
            APP_STATE.pendingCtx = t.payload || null;

            // é‡ç½®åˆ°è¾“å…¥æ€ï¼Œä¿è¯æ¼”ç¤ºé¡ºæ»‘
            document.getElementById('chatContainer').innerHTML = "";
            document.getElementById('heroLayer').classList.remove('hidden');
            document.getElementById('chatLayer').style.display = 'none';

            const input = document.getElementById('mainInput');
            input.value = t.suggestedPrompt || (t.desc || "æ‰§è¡Œä»»åŠ¡...");
            handleInput(t.scenario);

            // é»˜è®¤ï¼šä»»åŠ¡è¿›å…¥å¤„ç†æ€ï¼ˆä¿æŒå¯é‡å¤æ‰“å¼€ä¹ŸOKï¼‰
        }

        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('collapsed');
        }

        function newChat(){
            // æ–°å»ºå¯¹è¯ï¼šå›åˆ°è¾“å…¥æ€ï¼ˆä¿ç•™è§’è‰²ä¸ä¸Šä¸‹æ–‡ï¼‰
            document.getElementById('chatContainer').innerHTML = "";
            document.getElementById('heroLayer').classList.remove('hidden');
            document.getElementById('chatLayer').style.display = 'none';
            
            // æ˜¾ç¤ºKPIã€é‡è¦é€šçŸ¥å’Œå»ºè®®
            document.getElementById('topContextBar').style.display = 'block';
            document.getElementById('roleDashboard').style.display = 'block';
            
            const input = document.getElementById('mainInput');
            if (input){ input.value = ""; input.focus(); }
        }

        
        function setAdminGranularity(g){
            APP_STATE.adminGranularity = g;
            const ids = {today:"segToday", week:"segWeek", month:"segMonth"};
            ["segToday","segWeek","segMonth"].forEach(id=>{ const b=document.getElementById(id); if(b) b.classList.remove("active"); });
            const activeId = ids[g] || "segWeek";
            const ab = document.getElementById(activeId); if (ab) ab.classList.add("active");

            // è½»é‡æ¨¡æ‹Ÿï¼šä¸åŒç²’åº¦ä¸‹ KPI ç•¥æœ‰å˜åŒ–
            const map = {
                today: {att:"97.1%", risk:"1", can:"4.7", tasks:"6"},
                week:  {att:"97.6%", risk:"2", can:"4.6", tasks:"14"},
                month: {att:"97.3%", risk:"5", can:"4.5", tasks:"41"}
            };
            const v = map[g] || map.week;
            const a=document.getElementById("kpiAttendance"); if(a) a.textContent=v.att;
            const r=document.getElementById("kpiRisk"); if(r) r.textContent=v.risk;
            const c=document.getElementById("kpiCanteen"); if(c) c.textContent=v.can;
            const t=document.getElementById("kpiTasks"); if(t) t.textContent=v.tasks;
        }

function openTodoPopover(){
            const pop = document.getElementById('todoPopover');
            const fab = document.getElementById('todoFab');
            APP_STATE.todoSnoozed = false;
            if (pop){ pop.classList.remove('hidden'); }
            if (fab){ fab.classList.add('hidden'); }
        }

        function toggleTodoPopover(){
            const pop = document.getElementById('todoPopover');
            if (!pop) return;
            // å¦‚æœå·²ç¨åï¼Œåˆ™ç‚¹å‡»é“ƒé“›ä¹Ÿä¼šé‡æ–°æ‰“å¼€å¹¶å–æ¶ˆç¨å
            if (APP_STATE.todoSnoozed) APP_STATE.todoSnoozed = false;
            if (pop.classList.contains('hidden')) pop.classList.remove('hidden');
            else pop.classList.add('hidden');
        }

        function snoozeTodo(){
            const pop = document.getElementById('todoPopover');
            const fab = document.getElementById('todoFab');
            APP_STATE.todoSnoozed = true;
            if (pop){ pop.classList.add('hidden'); }
            if (fab){ fab.classList.remove('hidden'); }
        }


        function switchRole(role) {
            // åœ¨å·¥ä½œåŒºå†…å¿«é€Ÿåˆ‡æ¢èº«ä»½ï¼šæ¸…ç©ºå¯¹è¯ã€åˆ·æ–°ä¸»é¢˜ä¸å¾…åŠ
            if (!CONFIG[role]) return;
            enterWorkspace(role);
            APP_STATE.todoSnoozed = false;

            // æ¸…ç†è¾“å…¥/å¯¹è¯ï¼Œå›åˆ° Hero
            document.getElementById('chatContainer').innerHTML = "";
            document.getElementById('heroLayer').classList.remove('hidden');
            document.getElementById('chatLayer').style.display = 'none';
            document.getElementById('mainInput').value = "";

            showToast("èº«ä»½å·²åˆ‡æ¢", `å½“å‰èº«ä»½ï¼š${CONFIG[role].role} Â· ${CONFIG[role].name}`);
            renderTodos();
        }

        // ç»Ÿä¸€çš„â€œå‘èµ·è·¨è§’è‰²ä»»åŠ¡â€èƒ½åŠ›ï¼ˆé“¾è·¯Aæ ¸å¿ƒï¼‰
        
        // === 1.2 æ›´è´´è¿‘çœŸå®çš„â€œè§’è‰²æ¦‚è§ˆ/ä¸Šä¸‹æ–‡æ¡â€ ===
        function getStudentById(id){
            return (APP_STATE.roster || []).find(s => s.id === id) || APP_STATE.roster[0];
        }
        function getChildById(id){
            return (APP_STATE.children || []).find(c => c.id === id) || APP_STATE.children[0];
        }

        // ====== æ•™å­¦æ²»ç†æ¨¡æ‹Ÿç»Ÿè®¡ï¼šè–„å¼±ç‚¹è¶‹åŠ¿ & ç­çº§å¯¹æ¯”ï¼ˆç”¨äºç®¡ç†ç«¯é©¾é©¶èˆ±ï¼‰ ======
        function bumpSeries(arr, delta=1){
            // 7å¤©æ»šåŠ¨ï¼šä¸¢æ‰æœ€æ—©ä¸€å¤©ï¼Œæœ€åä¸€å¤©åŠ æƒå¢é•¿
            const a = (arr || [0,0,0,0,0,0,0]).slice(-7);
            while (a.length<7) a.unshift(0);
            a.shift();
            const last = a[a.length-1] || 0;
            a.push(Math.max(0, Math.round(last + delta)));
            return a;
        }

        function updateAdminAnalyticsOnPush(mode, selection, studentIds, className){
            const ana = APP_STATE.adminAnalytics || (APP_STATE.adminAnalytics = { weakPointTrend:{}, classCompare:[] });

            // è–„å¼±ç‚¹ï¼šæŒ‰çŸ¥è¯†ç‚¹/é”™å› /é¢˜ç›®è®¢æ­£éƒ½å½’ä¸€åˆ°â€œçŸ¥è¯†ç‚¹â€çƒ­åº¦ä¸Šï¼ˆæ¼”ç¤ºå£å¾„ï¼‰
            let focusKps = [];
            if (mode === "kp") focusKps = (selection.items || []);
            else if (mode === "tag") focusKps = [APP_STATE.lastHomeworkInsight?.kp || "ä¸€æ¬¡å‡½æ•°æˆªè·"];
            else {
                const qs = (selection.questions || []);
                focusKps = Array.from(new Set(qs.map(q=>q.kp))).filter(Boolean);
                if (focusKps.length===0) focusKps = [APP_STATE.lastHomeworkInsight?.kp || "ä¸€æ¬¡å‡½æ•°æˆªè·"];
            }

            focusKps.forEach(kp=>{
                const prev = ana.weakPointTrend[kp] || [3,3,4,4,5,5,6];
                // æ¨é€è¶Šå¤šäººï¼Œçƒ­åº¦è¶Šé«˜
                const delta = Math.min(6, Math.max(2, Math.round((studentIds?.length||1) * 0.8)));
                ana.weakPointTrend[kp] = bumpSeries(prev, delta);
            });

            // ç­çº§å¯¹æ¯”ï¼šæ¨é€è¶Šå¤š -> å®Œæˆç‡çŸ­æœŸä¸‹é™ä¸€ç‚¹ï¼ˆä»»åŠ¡å¢åŠ ï¼‰ï¼ŒæŒæ¡ç‡ç¼“æ…¢æ”¹å–„ï¼ˆç•™åˆ°å­¦ç”Ÿå®Œæˆå›ä¼ æ—¶å†æ‹‰é«˜ï¼‰
            ana.classCompare = (ana.classCompare || []);
            const target = ana.classCompare.find(x=>x.className===className);
            if (target){
                target.completion = Math.max(0.45, Math.min(0.95, (target.completion || 0.7) - 0.02));
            }

            APP_STATE.adminAnalytics = ana;
        }

        function updateAdminAnalyticsOnReturn(className, masteryLift=0.03){
            const ana = APP_STATE.adminAnalytics || (APP_STATE.adminAnalytics = { weakPointTrend:{}, classCompare:[] });
            const target = (ana.classCompare || []).find(x=>x.className===className);
            if (target){
                target.completion = Math.max(0.45, Math.min(0.98, (target.completion || 0.7) + 0.04));
                target.mastery = Math.max(0.45, Math.min(0.98, (target.mastery || 0.7) + masteryLift));
            }
            APP_STATE.adminAnalytics = ana;
        }

        function renderSparkline(values){
            const vals = (values || []).slice(-7);
            const w=180, h=44, pad=6;
            const min = Math.min(...vals);
            const max = Math.max(...vals);
            const span = Math.max(1e-6, max-min);
            const pts = vals.map((v,i)=>{
                const x = pad + i*( (w-2*pad)/(vals.length-1 || 1) );
                const y = pad + (h-2*pad) * (1 - (v-min)/span);
                return [x,y];
            });
            const d = pts.map((p,i)=> (i===0?`M ${p[0].toFixed(1)} ${p[1].toFixed(1)}`:`L ${p[0].toFixed(1)} ${p[1].toFixed(1)}`)).join(" ");
            return `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" style="display:block;">
                        <path d="${d}" fill="none" stroke="#111827" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"></path>
                        ${pts.map(p=>`<circle cx="${p[0].toFixed(1)}" cy="${p[1].toFixed(1)}" r="2.3" fill="#111827"></circle>`).join("")}
                    </svg>`;
        }



        
        function renderRoleDashboard(){
            const panelEl = document.getElementById("roleDashboard");
            const topEl = document.getElementById("topContextBar");
            if (!panelEl) return;

            if (!currentRole){
                panelEl.style.display="none";
                if (topEl){ topEl.style.display="none"; topEl.innerHTML=""; }
                return;
            }

            // å¯¹æ‰€æœ‰è§’è‰²åšâ€œæ·±åº¦ä¼˜åŒ–â€ï¼ŒåŒ…æ‹¬æ•™å¸ˆç«¯
            const deepRoles = ["student","parent","admin","teacher"];
            if (!deepRoles.includes(currentRole)) {
                panelEl.style.display = "none";
                if (topEl){ topEl.style.display="none"; topEl.innerHTML=""; }
                return;
            }

            const now = new Date();
            const y = now.getFullYear(), mo = String(now.getMonth()+1).padStart(2,"0"), d = String(now.getDate()).padStart(2,"0");
            const dateStr = `${y}-${mo}-${d}`;
            const dataPill = currentRole==="admin" ? "æ•°æ®ï¼šæ ¡çº§æ±‡æ€»(5må»¶è¿Ÿ)" : "æ•°æ®ï¼šç­çº§(å®æ—¶)";

            // ========== Top Context (lightweight, does not push center dialog) ==========
            if (topEl){
                topEl.style.display = "block";
                if (currentRole === "student"){
                    const stu = getStudentById(APP_STATE.currentStudentId);
                    topEl.innerHTML = `
                        <div class="ctx-bar">
                            <div class="ctx-left">
                                <span class="ctx-pill"><i class="ri-user-3-line"></i> å­¦ç”Ÿï¼š
                                    <select onchange="changeStudent(this.value)">
                                        ${(APP_STATE.roster||[]).map(s=>`<option value="${s.id}" ${s.id===stu.id?"selected":""}>${s.name}</option>`).join("")}
                                    </select>
                                </span>
                                <span class="ctx-pill"><i class="ri-community-line"></i> ç­çº§ï¼š${stu.className}</span>
                                <span class="ctx-pill"><i class="ri-calendar-line"></i> æ—¥æœŸï¼š${dateStr}</span>
                                <span class="ctx-pill"><i class="ri-database-2-line"></i> ${dataPill}</span>
                            </div>
                            <div class="ctx-right">
                                <button class="mini-btn primary" onclick="quickStudentStart()">å¼€å§‹ä»Šæ—¥ä»»åŠ¡</button>
                                <button class="mini-btn" onclick="handleInput('student_preview')">ç”Ÿæˆä»Šæ—¥å­¦ä¹ è®¡åˆ’</button>
                            </div>
                        </div>
                    `;
                } else if (currentRole === "parent"){
                    const stu = getStudentById(APP_STATE.currentStudentId);
                    topEl.innerHTML = `
                        <div class="ctx-bar">
                            <div class="ctx-left">
                                <span class="ctx-pill"><i class="ri-user-3-line"></i> å­©å­ï¼š${stu.name}ï¼ˆ${stu.className}ï¼‰</span>
                                <span class="ctx-pill"><i class="ri-calendar-line"></i> æ—¥æœŸï¼š${dateStr}</span>
                                <span class="ctx-pill"><i class="ri-database-2-line"></i> æ•°æ®ï¼šå­¦ä¸š+è¡Œä¸º(å®æ—¶)</span>
                            </div>
                            <div class="ctx-right">
                                <button class="mini-btn primary" onclick="handleInput('parent_report')">ç”Ÿæˆæˆé•¿å‘¨æŠ¥</button>
                                <button class="mini-btn" onclick="handleInput('parent_talk')">ç”Ÿæˆæ²Ÿé€šå•</button>
                            </div>
                        </div>
                    `;
                } else if (currentRole === "admin"){
                    topEl.innerHTML = `
                        <div class="ctx-bar">
                            <div class="ctx-left">
                                <span class="ctx-pill"><i class="ri-shield-check-line"></i> æ²»ç†é©¾é©¶èˆ±</span>
                                <span class="ctx-pill"><i class="ri-calendar-line"></i> æ—¥æœŸï¼š${dateStr}</span>
                                <span class="ctx-pill"><i class="ri-database-2-line"></i> ${dataPill}</span>
                            </div>
                            <div class="ctx-right">
                                <button class="mini-btn primary" onclick="handleInput('admin_dashboard')">æ‰“å¼€æœ¬å‘¨æ€»è§ˆ</button>
                                <button class="mini-btn" onclick="handleInput('admin_risk')">ç”Ÿæˆé£é™©å¤„ç½®å»ºè®®</button>
                            </div>
                        </div>
                    `;
                } else if (currentRole === "teacher"){
                    topEl.innerHTML = `
                        <div class="ctx-bar">
                            <div class="ctx-left">
                                <span class="ctx-pill"><i class="ri-user-3-line"></i> æ•™å¸ˆï¼šæ—è€å¸ˆ</span>
                                <span class="ctx-pill"><i class="ri-community-line"></i> ç­çº§ï¼šåˆäºŒ(3)ç­</span>
                                <span class="ctx-pill"><i class="ri-calendar-line"></i> æ—¥æœŸï¼š${dateStr}</span>
                                <span class="ctx-pill"><i class="ri-database-2-line"></i> æ•°æ®ï¼šç­çº§å­¦æƒ…(å®æ—¶)</span>
                            </div>
                            <div class="ctx-right">
                                <button class="mini-btn primary" onclick="handleInput('teacher_homework')">æ‰“å¼€ä½œä¸šåˆ†æ</button>
                            </div>
                        </div>
                    `;
                }
            }

            // ========== Panels under dialog (Manus-style) ==========
            panelEl.style.display = "block";
            if (currentRole === "admin") { setTimeout(()=>setAdminGranularity(APP_STATE.adminGranularity||"week"), 0); }

            if (currentRole === "student") {
                panelEl.innerHTML = `
                    
                    <div class="kpi-grid">
                        <div class="kpi"><div class="kpi-val">92%</div><div class="kpi-lbl">ä½œä¸šå®Œæˆç‡ï¼ˆ7å¤©ï¼‰</div></div>
                        <div class="kpi"><div class="kpi-val">3</div><div class="kpi-lbl">å¾…å¤„ç†é€šçŸ¥</div></div>
                        <div class="kpi"><div class="kpi-val">45min</div><div class="kpi-lbl">ä»Šæ—¥é¢„è®¡å­¦ä¹ </div></div>
                        <div class="kpi"><div class="kpi-val">86</div><div class="kpi-lbl">å£è¯­è¯„åˆ†ï¼ˆè¿‘7å¤©ï¼‰</div></div>
                    </div>

                    <div class="below-panels">
                        <div class="panel">
                            <div class="panel-hd"><span>è€å¸ˆé€šçŸ¥</span><span style="font-size:12px; color:#6b7280;">è¿‘ 24h</span></div>
                            <div class="panel-bd">
                                <div class="item">
                                    <div class="meta">
                                        <div class="title">æ•°å­¦ï¼šä¸€æ¬¡å‡½æ•°æˆªè·é”™å› çº æ­£ï¼ˆé‡ç‚¹ï¼‰</div>
                                        <div class="sub">æ¥è‡ªï¼šæ—è€å¸ˆ Â· å»ºè®®å…ˆåšâ€œåŒç±»é¢˜é€’è¿›â€å†çœ‹è®²è¯„</div>
                                    </div>
                                    <button class="mini-btn primary" onclick="openTopTask()">ç«‹å³å¤„ç†</button>
                                </div>
                                <div class="item">
                                    <div class="meta">
                                        <div class="title">è‹±è¯­ï¼šå‘¨äº”å£è¯­æ‰“å¡</div>
                                        <div class="sub">å†…å®¹ï¼šè‡ªæˆ‘ä»‹ç» + å¤è¿°çŸ­æ–‡ï¼ˆ2åˆ†é’Ÿï¼‰</div>
                                    </div>
                                    <button class="mini-btn" onclick="handleInput('student_speak')">å»ç»ƒä¹ </button>
                                </div>
                            </div>
                        </div>
                        <div class="panel">
                            <div class="panel-hd"><span>å­¦ä¹ å»ºè®®</span><span style="font-size:12px; color:#6b7280;">ä»Šæ—¥</span></div>
                            <div class="panel-bd">
                                <div class="item">
                                    <div class="meta">
                                        <div class="title">ä¼˜å…ˆé¡ºåº</div>
                                        <div class="sub">é”™å› çº æ­£ â†’ åŒç±»é¢˜ 3 é“ â†’ è®²è¯„å›çœ‹ï¼ˆé¢„è®¡ 18 åˆ†é’Ÿï¼‰</div>
                                    </div>
                                    <button class="mini-btn" onclick="handleInput('student_preview')">ç”Ÿæˆè®¡åˆ’</button>
                                </div>
                                <div class="item">
                                    <div class="meta">
                                        <div class="title">æå‡å»ºè®®</div>
                                        <div class="sub">å®¡é¢˜æ—¶å…ˆåœˆâ€œæˆªè·/äº¤ç‚¹/åŒºé—´â€ï¼Œå†ä»£å…¥æ£€éªŒï¼ˆå‡å°‘ç²—å¿ƒï¼‰</div>
                                    </div>
                                    <button class="mini-btn" onclick="handleInput('student_error')">åšç»ƒä¹ </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            if (currentRole === "parent") {
                panelEl.innerHTML = `
                    
                    <div class="kpi-grid">
                        <div class="kpi"><div class="kpi-val">1</div><div class="kpi-lbl">å¾…ç¡®è®¤äº‹é¡¹</div></div>
                        <div class="kpi"><div class="kpi-val">88%</div><div class="kpi-lbl">ä½œä¸šå®Œæˆï¼ˆ7å¤©ï¼‰</div></div>
                        <div class="kpi"><div class="kpi-val">+6</div><div class="kpi-lbl">æ•°å­¦æŒæ¡åº¦å˜åŒ–</div></div>
                        <div class="kpi"><div class="kpi-val">12min</div><div class="kpi-lbl">å®¶æ ¡æ²Ÿé€šæ—¶é•¿ï¼ˆå‘¨ï¼‰</div></div>
                    </div>

                    <div class="below-panels">
                        <div class="panel">
                            <div class="panel-hd"><span>é‡ç‚¹æé†’</span><span style="font-size:12px; color:#6b7280;">è¿‘ 7 å¤©</span></div>
                            <div class="panel-bd">
                                <div class="item">
                                    <div class="meta">
                                        <div class="title">æ•°å­¦ï¼šäºŒæ¬¡å‡½æ•°æœ€å€¼ï¼ˆæŒæ¡ç‡åä½ï¼‰</div>
                                        <div class="sub">å»ºè®®ï¼šæœ¬å‘¨å®Œæˆ 2 æ¬¡â€œå›¾åƒè¯»æˆªè·â€ä¸“é¡¹ç»ƒä¹ </div>
                                    </div>
                                    <button class="mini-btn primary" onclick="handleInput('parent_talk')">ç”Ÿæˆæ²Ÿé€šå•</button>
                                </div>
                                <div class="item">
                                    <div class="meta">
                                        <div class="title">ä½œä¸šä¹ æƒ¯ï¼šæ™šé—´æäº¤åæ™š</div>
                                        <div class="sub">å»ºè®®ï¼šå›ºå®š 20:30 å‰å®Œæˆï¼Œé™ä½ç–²åŠ³å¯¼è‡´çš„é”™è¯¯</div>
                                    </div>
                                    <button class="mini-btn" onclick="handleInput('parent_guide')">ç”Ÿæˆè¡ŒåŠ¨è®¡åˆ’</button>
                                </div>
                            </div>
                        </div>
                        <div class="panel">
                            <div class="panel-hd"><span>å®¶åº­å…±è‚²å»ºè®®</span><span style="font-size:12px; color:#6b7280;">å¯æ‰§è¡Œ</span></div>
                            <div class="panel-bd">
                                <div class="item">
                                    <div class="meta">
                                        <div class="title">7 å¤©è¡ŒåŠ¨</div>
                                        <div class="sub">æ¯å¤© 15 åˆ†é’Ÿï¼šè®¢æ­£ 1 é¢˜ + å¤è¿°é”™å› ï¼ˆå®¶é•¿åªé—® 2 ä¸ªé—®é¢˜ï¼‰</div>
                                    </div>
                                    <button class="mini-btn primary" onclick="handleInput('parent_guide')">ç”Ÿæˆ 7 å¤©è®¡åˆ’</button>
                                </div>
                                <div class="item">
                                    <div class="meta">
                                        <div class="title">æ²Ÿé€šå»ºè®®</div>
                                        <div class="sub">ç”¨â€œè¿‡ç¨‹è¡¨æ‰¬ + å…·ä½“ç­–ç•¥â€æ›¿ä»£ç»“æœè¯„ä»·ï¼ˆå‡å°‘å¯¹æŠ—ï¼‰</div>
                                    </div>
                                    <button class="mini-btn" onclick="handleInput('parent_talk')">ä¸€é”®ç”Ÿæˆå•</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            if (currentRole === "admin") {
                panelEl.innerHTML = `
                    
                    <div class="seg" style="display:flex; justify-content:space-between; align-items:center; margin:10px 0 0;">
                        <div class="seg-pill" style="font-size:12px; color:#6b7280;">æ—¶é—´ç²’åº¦</div>
                        <div class="seg-ctls" style="background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:2px;">
                            <button class="seg-btn active" id="segToday" onclick="setAdminGranularity('today')">ä»Šæ—¥</button>
                            <button class="seg-btn" id="segWeek" onclick="setAdminGranularity('week')">æœ¬å‘¨</button>
                            <button class="seg-btn" id="segMonth" onclick="setAdminGranularity('month')">æœ¬æœˆ</button>
                        </div>
                    </div>

                    <div class="kpi-grid" id="adminKpiGrid">
                        <div class="kpi"><div class="kpi-val" id="kpiAttendance">97.6%</div><div class="kpi-lbl">å‡ºå‹¤ç‡</div></div>
                        <div class="kpi"><div class="kpi-val" id="kpiRisk">2</div><div class="kpi-lbl">é£é™©äº‹ä»¶</div></div>
                        <div class="kpi"><div class="kpi-val" id="kpiCanteen">4.6</div><div class="kpi-lbl">é£Ÿå ‚æ»¡æ„åº¦</div></div>
                        <div class="kpi"><div class="kpi-val" id="kpiTasks">14</div><div class="kpi-lbl">æ²»ç†äº‹é¡¹</div></div>
                    </div>

                    <div class="below-panels">
                        <div class="panel">
                            <div class="panel-hd"><span>é£é™© Top</span><span style="font-size:12px; color:#6b7280;">æœ¬å‘¨</span></div>
                            <div class="panel-bd">
                                <div class="item">
                                    <div class="meta">
                                        <div class="title">å­¦æƒ…ï¼šå‡½æ•°æ¨¡å—è–„å¼±ç‚¹ä¸Šå‡</div>
                                        <div class="sub">å¹´çº§ï¼šå…«å¹´çº§ Â· é‡ç‚¹ç­çº§ï¼š8(2)ã€8(5)</div>
                                    </div>
                                    <button class="mini-btn primary" onclick="handleInput('admin_dashboard')">æŸ¥çœ‹è¶‹åŠ¿</button>
                                </div>
                                <div class="item">
                                    <div class="meta">
                                        <div class="title">å®‰å…¨ï¼šæ“åœºæ‹¥æŒ¤é¢„è­¦</div>
                                        <div class="sub">åˆé—´ 12:10â€“12:25 Â· å»ºè®®å¢æ´¾å·¡æŸ¥</div>
                                    </div>
                                    <button class="mini-btn" onclick="handleInput('admin_safe')">ç”Ÿæˆå¤„ç½®å•</button>
                                </div>
                            </div>
                        </div>
                        <div class="panel">
                            <div class="panel-hd"><span>æ²»ç†å»ºè®®</span><span style="font-size:12px; color:#6b7280;">å¯æ´¾å•</span></div>
                            <div class="panel-bd">
                                <div class="item">
                                    <div class="meta">
                                        <div class="title">å­¦æƒ…ç£å¯¼</div>
                                        <div class="sub">é’ˆå¯¹â€œæˆªè·/æœ€å€¼â€å‘èµ·ä¸“é¡¹ä½œä¸š + è®²è¯„ï¼Œè¿½è¸ªå®Œæˆç‡ä¸æŒæ¡ç‡</div>
                                    </div>
                                    <button class="mini-btn primary" onclick="handleInput('admin_risk')">ç”Ÿæˆæ´¾å•</button>
                                </div>
                                <div class="item">
                                    <div class="meta">
                                        <div class="title">é£Ÿå ‚æ»¡æ„åº¦</div>
                                        <div class="sub">å»ºè®®ï¼šæœ¬å‘¨åšä¸€æ¬¡â€œè¥å…»+ä»·æ ¼â€é—®å·é‡‡æ ·ï¼Œä¼˜åŒ–èœå•ç»“æ„</div>
                                    </div>
                                    <button class="mini-btn" onclick="handleInput('admin_canteen')">ç”Ÿæˆæ–¹æ¡ˆ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            if (currentRole === "teacher") {
                panelEl.innerHTML = `
                    
                    <div class="kpi-grid">
                        <div class="kpi">
                            <div class="kpi-val">92%</div>
                            <div class="kpi-lbl">ä½œä¸šå®Œæˆç‡ï¼ˆ7å¤©ï¼‰<br><span style="font-size:10px; color:#10b981;">ç¯æ¯” +4%</span></div>
                        </div>
                        <div class="kpi">
                            <div class="kpi-val">77%</div>
                            <div class="kpi-lbl">ä¸€æ¬¡å‡½æ•°-æˆªè·ï¼ˆæœ¬å‘¨ï¼‰<br><span style="font-size:10px; color:#ef4444;">ä½äºå¹´çº§å‡å€¼ 82%</span></div>
                        </div>
                        <div class="kpi">
                            <div class="kpi-val">86%</div>
                            <div class="kpi-lbl">è®¢æ­£å›ä¼ ç‡<br><span style="font-size:10px; color:#6b7280;">12/14 å·²å›ä¼ </span></div>
                        </div>
                        <div class="kpi">
                            <div class="kpi-val">3</div>
                            <div class="kpi-lbl">å¾…è·Ÿè¿›äº‹é¡¹<br><span style="font-size:10px; color:#6b7280;">è®²è¯„åˆ†å±‚/å®¶æ ¡</span></div>
                        </div>
                    </div>

                    <div class="below-panels">
                        <div class="panel">
                            <div class="panel-hd"><span>é€šçŸ¥</span><span style="font-size:12px; color:#6b7280;">è¿‘ 24h</span></div>
                            <div class="panel-bd">
                                <div class="item">
                                    <div class="meta">
                                        <div class="title">ç»ƒä¹ å›ä¼ æé†’ï¼šä¸€æ¬¡å‡½æ•°æˆªè·ï¼ˆ12/14 å·²å›ä¼ ï¼‰</div>
                                        <div class="sub">å»ºè®®ï¼šä¼˜å…ˆç”Ÿæˆ 5 åˆ†é’Ÿè®²è¯„è¯¾ä»¶ï¼Œå¹¶å¯¹æœªå›ä¼ å­¦ç”Ÿå•ç‹¬æé†’</div>
                                    </div>
                                    <div style="display:flex; gap:8px;">
                                        <button class="mini-btn" onclick="handleInput('teacher_lesson')">ç”Ÿæˆè®²è¯„</button>
                                        <button class="mini-btn" onclick="handleInput('teacher_homework')">æŸ¥çœ‹å›ä¼ </button>
                                    </div>
                                </div>
                                <div class="item">
                                    <div class="meta">
                                        <div class="title">ä½æŒæ¡ç‡é¢„è­¦ï¼šäºŒæ¬¡å‡½æ•°æœ€å€¼ï¼ˆæŒæ¡ç‡ 77%ï¼‰</div>
                                        <div class="sub">å»ºè®®ï¼šæŒ‰é”™å› æ ‡ç­¾åˆ†å±‚æ¨é€ï¼ˆè¯»å›¾/è®¡ç®—/å®¡é¢˜ï¼‰</div>
                                    </div>
                                    <div style="display:flex; gap:8px;">
                                        <button class="mini-btn" onclick="openPushModal()">é…ç½®æ¨é€</button>
                                        <button class="mini-btn" onclick="handleInput('teacher_homework')">ç”Ÿæˆåˆ†å±‚</button>
                                    </div>
                                </div>
                                <div class="item">
                                    <div class="meta">
                                        <div class="title">å­¦ä¹ è¡Œä¸ºæé†’ï¼šææ˜è¿‘ 3 æ¬¡æäº¤å»¶è¿Ÿ</div>
                                        <div class="sub">å»ºè®®ï¼šå…ˆå‘é€å­¦ä¹ èŠ‚å¥æé†’ï¼Œå¦‚æ— æ”¹å–„å†å‘èµ·å®¶æ ¡æ²Ÿé€šå•</div>
                                    </div>
                                    <div style="display:flex; gap:8px;">
                                        <button class="mini-btn" onclick="handleInput('teacher_paper')">ç”Ÿæˆæ²Ÿé€šå•</button>
                                        <button class="mini-btn" onclick="dismissTask('')">ç¨åå¤„ç†</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="panel">
                            <div class="panel-hd"><span>å»ºè®®</span><span style="font-size:12px; color:#6b7280;">å¯æ‰§è¡Œ</span></div>
                            <div class="panel-bd">
                                <div class="item">
                                    <div class="meta">
                                        <div class="title">åˆ†å±‚è®²è¯„ï¼šå…ˆç»Ÿä¸€â€œæˆªè·å®šä¹‰â€å†åšâ€œè¯»å›¾â†’ä»£å…¥â€</div>
                                        <div class="sub">A ç±»è¯»å›¾é”™è¯¯ï¼šå¼ºè°ƒåæ ‡è½´äº¤ç‚¹ï¼›B ç±»è®¡ç®—é”™è¯¯ï¼šæ¿æ¼”è§„èŒƒæ­¥éª¤</div>
                                    </div>
                                    <button class="mini-btn primary" onclick="handleInput('teacher_lesson')">ç”Ÿæˆè¯¾ä»¶</button>
                                </div>
                                <div class="item">
                                    <div class="meta">
                                        <div class="title">åˆ†å±‚ä½œä¸šï¼šåŸºç¡€ 1 é¢˜ | æå‡ 1 é¢˜ | æ‹“å±• 1 é¢˜</div>
                                        <div class="sub">å°†å·©å›ºä½œä¸šæŒ‰ A/B/C ç»„ä¸‹å‘ï¼Œå‡å°‘ä¸€åˆ€åˆ‡è´Ÿæ‹…</div>
                                    </div>
                                    <button class="mini-btn primary" onclick="handleInput('teacher_homework')">ä¸€é”®ç”Ÿæˆ</button>
                                </div>
                                <div class="item">
                                    <div class="meta">
                                        <div class="title">å®¶æ ¡ååŒï¼šè–„å¼±ç‚¹ + 7å¤©æ¸¸å­¦è¡ŒåŠ¨ï¼ˆ10åˆ†é’Ÿ/å¤©ï¼‰</div>
                                        <div class="sub">å¯¹æŒç»­åä½å­¦ç”Ÿï¼Œè‡ªåŠ¨æ‘˜è¦è–„å¼±ç‚¹å¹¶ç»™å®¶é•¿å¯æ‰§è¡ŒåŠ¨ä½œ</div>
                                    </div>
                                    <div style="display:flex; gap:8px;">
                                        <button class="mini-btn" onclick="handleInput('parent_report')">ç”Ÿæˆå‘¨æŠ¥</button>
                                        <button class="mini-btn" onclick="handleInput('parent_connect')">ç”Ÿæˆæ²Ÿé€šå•</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
        }


        function changeStudent(id){
            APP_STATE.currentStudentId = id;
            // åŒæ­¥è§’è‰²åå±•ç¤ºæ›´è´´è¿‘çœŸå®
            const stu = getStudentById(id);
            CONFIG.student.name = stu.name;
            CONFIG.student.role = stu.className;
            switchRole("student");
        }
        function changeChild(id){
            APP_STATE.currentChildId = id;
            switchRole("parent");
        }
        function changeAdminRange(val){
            // æ¼”ç¤ºç”¨ï¼šä»…åˆ·æ–°é¢æ¿ï¼›çœŸå®ç³»ç»Ÿä¼šè§¦å‘é‡æ‹‰æ•°æ®
            showToast("å·²åˆ‡æ¢æ—¶é—´èŒƒå›´", `å½“å‰ï¼š${val === "today" ? "ä»Šæ—¥" : val === "week" ? "æœ¬å‘¨" : "æœ¬æœˆ"}`);
            renderRoleDashboard();
        }

        function openTopTask(){
            const role = currentRole;
            const list = getActiveTasks(role);
            if (list.length===0){ showToast("æš‚æ— å¾…åŠ", "è¯·å…ˆç”±æ•™å¸ˆç«¯æ¨é€æˆ–è§¦å‘åœºæ™¯ã€‚"); return; }
            openTask(list[0].id);
        }
        function quickStudentStart(){
            // ä¼˜å…ˆæ‰“å¼€ç¬¬ä¸€æ¡å¾…åŠï¼Œå¦åˆ™è¿›å…¥é”™é¢˜è¯Šæ–­
            const list = getActiveTasks("student");
            if (list.length) { openTask(list[0].id); return; }
            document.getElementById('mainInput').value = "æˆ‘æƒ³å…ˆåšä¸€æ¬¡é”™é¢˜è¯Šæ–­ï¼šè¯·ä»å®¡é¢˜åˆ°å»ºæ¨¡å¸®æˆ‘çº åã€‚";
            handleInput("student_mistake");
        }
function emitTask(toRole, task) {
            addTask(toRole, task);
            showToast("å·²æ¨é€ä»»åŠ¡", `å·²æ¨é€è‡³ã€${CONFIG[toRole].role}ã€‘å¾…åŠï¼š${task.title}`, [
                { label: "ç«‹å³æŸ¥çœ‹", primary: true, onClick: () => switchRole(toRole) }
            ]);
        }

        function consumePendingCtx() {
            const c = APP_STATE.pendingCtx;
            APP_STATE.pendingCtx = null;
            return c;
        }


        // === 2. æ ¸å¿ƒäº¤äº’é€»è¾‘ ===
        function enterWorkspace(role) {
            currentRole = role;
            const data = CONFIG[role];
            
            // åŠ¨æ€é…è‰²
            document.documentElement.style.setProperty('--theme-color', data.color);
            document.documentElement.style.setProperty('--theme-bg', data.bg);
            
            // æ¸²æŸ“ä¾§è¾¹æ 
            document.getElementById('userBadge').innerHTML = `
                <div style="width:40px; height:40px; border-radius:10px; background:${data.bg}; color:${data.color}; display:flex; align-items:center; justify-content:center; font-size:20px;">
                    <i class="ri-user-smile-line"></i>
                </div>
                <div>
                    <div style="font-weight:600; font-size:14px; color:#111;">${data.name}</div>
                    <div style="font-size:11px; color:#888;">${data.role}</div>
                </div>
            `;
            
            // æ¸²æŸ“ Hero
            document.getElementById('heroGreeting').innerText = data.greeting;
            document.getElementById('mainInput').placeholder = data.placeholder;
            
            const pc = document.getElementById('pillContainer');
            pc.innerHTML = '';
            data.pills.forEach(p => {
                const el = document.createElement('div');
                el.className = 'pill';
                el.innerHTML = `<i class="${p.icon}" style="color:${data.color}"></i> ${p.text}`;
                el.onclick = () => handlePill(p.action);
                pc.appendChild(el);
            });

            // è½¬åœº
            document.getElementById('portalScene').classList.add('hidden');
            document.getElementById('workspaceScene').classList.add('active');
            renderTodos();
            renderRoleDashboard();
            
            // æ˜¾ç¤ºKPIã€é‡è¦é€šçŸ¥å’Œå»ºè®®
            document.getElementById('topContextBar').style.display = 'block';
            document.getElementById('roleDashboard').style.display = 'block';
        }

        function exitWorkspace() {
            document.getElementById('workspaceScene').classList.remove('active');
            document.getElementById('portalScene').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('heroLayer').classList.remove('hidden');
                document.getElementById('chatLayer').style.display = 'none';
                document.getElementById('chatContainer').innerHTML = '';
                document.getElementById('mainInput').value = '';
            }, 500);
        }

        function handlePill(action) {
            const input = document.getElementById('mainInput');
            // é¢„è®¾ Prompt
            const prompts = {
                teacher_lesson: "å¸®æˆ‘ç”ŸæˆåˆäºŒæ•°å­¦ã€Šå‹¾è‚¡å®šç†ã€‹ç¬¬ä¸€è¯¾æ—¶çš„æ•™å­¦è®¾è®¡ï¼Œæ³¨é‡æ•°å½¢ç»“åˆæ€æƒ³ï¼ŒåŒ…å«åˆ†å±‚ç»ƒä¹ ã€‚",
                teacher_homework: "åˆ†ææ˜¨æ—¥åˆäºŒ(3)ç­æ•°å­¦ä½œä¸šæ•°æ®ï¼ŒåŒ…å«å®¢è§‚é¢˜æ­£ç¡®ç‡å’Œä¸»è§‚é¢˜åˆè¯„ã€‚",
                teacher_paper: "æˆ‘æƒ³å†™ä¸€ç¯‡å…³äºâ€œåˆä¸­æ•°å­¦æ•°å½¢ç»“åˆæ•™å­¦â€çš„è®ºæ–‡ï¼Œè¯·æ¨èé€‰é¢˜å¹¶æ¢³ç†æ–‡çŒ®ã€‚",
                
                student_mistake: "è¿™é“å‡½æ•°é¢˜æˆ‘åšé”™äº†ï¼ˆå·²ä¸Šä¼ å›¾ç‰‡ï¼‰ï¼Œè¯·å¸®æˆ‘è¯Šæ–­é”™è¯¯å¹¶æ¨é€åŒç±»é¢˜ã€‚",
                student_english: "æˆ‘æƒ³ç»ƒä¹ â€œæœºåœºå€¼æœºâ€åœºæ™¯çš„è‹±è¯­å¯¹è¯ï¼Œä½ æ‰®æ¼”åœ°å‹¤äººå‘˜ã€‚",
                student_preview: "ç”Ÿæˆæ˜æ—¥è¯¾ç¨‹çš„é¢„ä¹ è®¡åˆ’ï¼Œæˆ‘æ˜¯åˆäºŒå­¦ç”Ÿï¼Œé‡ç‚¹å…³æ³¨ç‰©ç†â€œå…‰çš„æŠ˜å°„â€ã€‚",
                
                parent_report: "ç”Ÿæˆææ˜æœ¬å‘¨çš„æˆé•¿å‘¨æŠ¥ï¼ŒåŒ…å«å­¦ä¸šã€ä½“è´¨å’Œç´ å…»ä¸‰ä¸ªç»´åº¦ã€‚",
                parent_connect: "æŸ¥è¯¢å­©å­è¿‘æœŸçš„å­¦ä¸šè¿›åº¦ï¼Œæ˜¯å¦æœ‰å¼‚å¸¸æƒ…å†µé¢„è­¦ï¼Ÿ",
                parent_edu: "å­©å­æœ€è¿‘æœ‰äº›åŒå­¦æƒ…ç»ªï¼Œä½œä¸ºå®¶é•¿æˆ‘è¯¥å¦‚ä½•æ²Ÿé€šï¼Ÿè¯·æä¾›æŒ‡å¯¼ã€‚",
                
                admin_safety: "æ‰«æå…¨æ ¡å®‰é˜²ç›‘æ§ï¼Œè¯†åˆ«å¼‚å¸¸äººå‘˜å’ŒåŒºåŸŸå…¥ä¾µé£é™©ã€‚",
                admin_activity: "ç”ŸæˆåˆäºŒå¹´çº§å­¦æƒ…åˆ†ææŠ¥å‘Šï¼Œé‡ç‚¹å…³æ³¨è–„å¼±çŸ¥è¯†ç‚¹ã€‚",
                admin_canteen: "ç”Ÿæˆæœ¬å‘¨é£Ÿå ‚è¿è¥æŠ¥å‘Šï¼ŒåŒ…å«è¥å…»åˆ†æå’Œå­¦ç”Ÿæ»¡æ„åº¦ä¼˜åŒ–å»ºè®®ã€‚"
            };
            
            input.value = prompts[action] || "æ‰§è¡Œæ“ä½œ...";
            handleInput(action);
        }

        function handleInput(actionType = 'generic') {
            const text = document.getElementById('mainInput').value;
            if (!text) return;

            document.getElementById('heroLayer').classList.add('hidden');
            document.getElementById('chatLayer').style.display = 'block';
            
            // éšè—KPIã€é‡è¦é€šçŸ¥å’Œå»ºè®®
            document.getElementById('topContextBar').style.display = 'none';
            document.getElementById('roleDashboard').style.display = 'none';

            addMsg('User', text);
            setTimeout(() => startDeepDive(actionType), 600);
        }


        function prefillAndRun(actionType, text){
            document.getElementById('mainInput').value = text || "";
            handleInput(actionType);
        }


        // === 2.1 é“¾è·¯Aï¼šè·¨è§’è‰²é—­ç¯åŠ¨ä½œï¼ˆTeacher â†’ Student â†’ Teacherï¼‰ ===
        
        // === 2.1.1 é“¾è·¯Aå¢å¼ºï¼šå¯é…ç½®æ¨é€ï¼ˆé€‰çŸ¥è¯†ç‚¹ + é€‰å­¦ç”Ÿï¼‰ ===
        
function setPushMode(mode){
            APP_STATE.pushMode = mode;

            const btnK = document.getElementById("pushMode_kp");
            const btnT = document.getElementById("pushMode_tag");
            const btnQ = document.getElementById("pushMode_q");
            if (btnK) btnK.classList.toggle("active", mode==="kp");
            if (btnT) btnT.classList.toggle("active", mode==="tag");
            if (btnQ) btnQ.classList.toggle("active", mode==="q");

            const pK = document.getElementById("pick_kp");
            const pT = document.getElementById("pick_tag");
            const pQ = document.getElementById("pick_q");
            if (pK) pK.style.display = (mode==="kp") ? "block" : "none";
            if (pT) pT.style.display = (mode==="tag") ? "block" : "none";
            if (pQ) pQ.style.display = (mode==="q") ? "block" : "none";

            const title = document.getElementById("pickTitle");
            if (title){
                title.textContent = mode==="kp" ? "çŸ¥è¯†ç‚¹ï¼ˆå¯å¤šé€‰ï¼‰" : (mode==="tag" ? "é”™å› æ ‡ç­¾ï¼ˆå¯å¤šé€‰ï¼‰" : "é¢˜ç›®è®¢æ­£ï¼ˆå¯å¤šé€‰ï¼‰");
            }
        }

        function openPushModal(){
            const insight = APP_STATE.lastHomeworkInsight;
            if (!insight) {
                showToast("æœªæ‰¾åˆ°ä½œä¸šæ´å¯Ÿ", "è¯·å…ˆè¿è¡Œã€Œä½œä¸šæ•°æ®åˆ†æã€åœºæ™¯ã€‚");
                return;
            }
            const modal = document.getElementById("pushModal");
            const kpList = document.getElementById("kpPickList");
            const tagList = document.getElementById("tagPickList");
            const qList = document.getElementById("qPickList");
            const stuList = document.getElementById("stuPickList");
            if (!modal || !kpList || !tagList || !qList || !stuList) return;

            // æ¨èçŸ¥è¯†ç‚¹ï¼šæ¥è‡ªæ´å¯Ÿ + 2 ä¸ªå¸¸è§æ‰©å±•ï¼ˆæ¼”ç¤ºæ›´çœŸå®ï¼‰
            const kpCandidates = [
                insight.kp,
                "ä¸€æ¬¡å‡½æ•°å›¾åƒä¸æˆªè·å…³ç³»",
                "ç”¨ç‚¹æ±‚ä¸€æ¬¡å‡½æ•°è§£æå¼"
            ];
            kpList.innerHTML = kpCandidates.map((kp,i)=>`
                <li>
                    <label style="display:flex; align-items:center; gap:10px; cursor:pointer; flex:1;">
                        <input type="checkbox" class="kpPick" value="${kp}" ${i===0?"checked":""} />
                        <span style="font-size:13px; color:#111827; font-weight:600;">${kp}</span>
                    </label>
                    <span style="font-size:12px; color:#6b7280;">${i===0?"æ´å¯Ÿå‘½ä¸­":"æ‰©å±•"}</span>
                </li>
            `).join("");

            // é”™å› æ ‡ç­¾ï¼šæ¥è‡ªæ´å¯Ÿ
            const tags = (insight.errorTags || []);
            tagList.innerHTML = tags.map((t,i)=>`
                <li>
                    <label style="display:flex; align-items:flex-start; gap:10px; cursor:pointer; flex:1;">
                        <input type="checkbox" class="tagPick" value="${t.tag}" ${i===0?"checked":""} />
                        <div>
                            <div style="font-size:13px; color:#111827; font-weight:700;">${t.tag}</div>
                            <div style="font-size:12px; color:#6b7280; line-height:1.35;">${t.desc}</div>
                        </div>
                    </label>
                    <span style="font-size:12px; color:#6b7280;">${t.count}é¢˜</span>
                </li>
            `).join("");

            // é¢˜ç›®è®¢æ­£ï¼šæ¥è‡ªé¢˜åº“ï¼ˆæ¼”ç¤ºï¼‰
            const qs = (insight.questionBank || []);
            qList.innerHTML = qs.map((q,i)=>`
                <li>
                    <label style="display:flex; align-items:flex-start; gap:10px; cursor:pointer; flex:1;">
                        <input type="checkbox" class="qPick" value="${q.id}" data-kp="${q.kp}" data-tag="${q.tag}" ${i===0?"checked":""} />
                        <div>
                            <div style="font-size:13px; color:#111827; font-weight:800;">${q.id} <span style="font-weight:650; color:#6b7280;">Â· ${q.tag}</span></div>
                            <span class="qStem">${q.stem}</span>
                        </div>
                    </label>
                </li>
            `).join("");

            // å­¦ç”Ÿåˆ—è¡¨ï¼šé»˜è®¤å‹¾é€‰æ´å¯Ÿå…³æ³¨å­¦ç”Ÿ
            const focus = new Set(insight.focusStudents || []);
            stuList.innerHTML = (APP_STATE.roster||[]).map(s=>`
                <li>
                    <label style="display:flex; align-items:center; gap:10px; cursor:pointer; flex:1;">
                        <input type="checkbox" class="stuPick" value="${s.id}" ${focus.has(s.name)?"checked":""} />
                        <span style="font-size:13px; color:#111827; font-weight:600;">${s.name}</span>
                    </label>
                    <span style="font-size:12px; color:#6b7280;">${s.className}</span>
                </li>
            `).join("");

            setPushMode("kp");
            modal.style.display="flex";
        }

function closePushModal(){
            const modal = document.getElementById("pushModal");
            if (modal) modal.style.display="none";
        }

        function toggleAll(which, checked){
            let cls = ".stuPick";
            if (which === "kp") cls = ".kpPick";
            if (which === "tag") cls = ".tagPick";
            if (which === "q") cls = ".qPick";
            if (which === "stu") cls = ".stuPick";
            document.querySelectorAll(cls).forEach(el => el.checked = checked);
        }

        
function confirmPushModal(){
            const insight = APP_STATE.lastHomeworkInsight;
            if (!insight) return;

            const mode = APP_STATE.pushMode || "kp";
            const stus = Array.from(document.querySelectorAll(".stuPick")).filter(x=>x.checked).map(x=>x.value);

            if (stus.length === 0){ showToast("æœªé€‰æ‹©å­¦ç”Ÿ", "è¯·è‡³å°‘é€‰æ‹© 1 åå­¦ç”Ÿã€‚"); return; }

            // é€‰æ‹©æ¨é€å†…å®¹
            let selection = { mode, items: [], questions: [] };

            if (mode === "kp"){
                const kps = Array.from(document.querySelectorAll(".kpPick")).filter(x=>x.checked).map(x=>x.value);
                if (kps.length === 0){ showToast("æœªé€‰æ‹©çŸ¥è¯†ç‚¹", "è¯·è‡³å°‘é€‰æ‹© 1 ä¸ªçŸ¥è¯†ç‚¹ã€‚"); return; }
                selection.items = kps;
            } else if (mode === "tag"){
                const tags = Array.from(document.querySelectorAll(".tagPick")).filter(x=>x.checked).map(x=>x.value);
                if (tags.length === 0){ showToast("æœªé€‰æ‹©é”™å› æ ‡ç­¾", "è¯·è‡³å°‘é€‰æ‹© 1 ä¸ªé”™å› æ ‡ç­¾ã€‚"); return; }
                selection.items = tags;
            } else {
                const qids = Array.from(document.querySelectorAll(".qPick")).filter(x=>x.checked).map(x=>x.value);
                if (qids.length === 0){ showToast("æœªé€‰æ‹©é¢˜ç›®", "è¯·è‡³å°‘é€‰æ‹© 1 é“é¢˜ç›®ã€‚"); return; }
                const bank = insight.questionBank || [];
                selection.questions = bank.filter(q=>qids.includes(q.id));
                selection.items = qids;
            }

            // ç”Ÿæˆå­¦ç”Ÿç«¯å¾…åŠï¼šæ¯åå­¦ç”Ÿ 1 ä¸ªä»»åŠ¡ï¼ˆæ›´è´´è¿‘çœŸå®ï¼šä¸€ä¸ªä»»åŠ¡é‡ŒåŒ…å«å¤šä¸ªçŸ¥è¯†ç‚¹/é”™å› /é¢˜ç›®ï¼‰
            let count = 0;
            stus.forEach(sid=>{
                const stu = getStudentById(sid);
                const taskId = uid("task");

                let title = "é”™é¢˜å·©å›º";
                let desc = `æ¥è‡ªæ•™å¸ˆæ¨é€ Â· ç­çº§ï¼š${insight.className}`;
                if (mode==="kp"){
                    title = `é”™é¢˜å·©å›ºï¼š${selection.items[0]}${selection.items.length>1?" ç­‰":""}`;
                    desc += ` Â· çŸ¥è¯†ç‚¹ï¼š${selection.items.slice(0,2).join("ã€")}${selection.items.length>2?"â€¦":""} Â· å…¸å‹é”™å› ï¼š${insight.topError}`;
                }
                if (mode==="tag"){
                    title = `é”™å› çº æ­£ï¼š${selection.items[0]}${selection.items.length>1?" ç­‰":""}`;
                    desc += ` Â· é”™å› æ ‡ç­¾ï¼š${selection.items.slice(0,2).join("ã€")}${selection.items.length>2?"â€¦":""} Â· å‘½ä¸­çŸ¥è¯†ç‚¹ï¼š${insight.kp}`;
                }
                if (mode==="q"){
                    title = `é”™é¢˜è®¢æ­£ï¼š${selection.items.slice(0,2).join(",")}${selection.items.length>2?"â€¦":""}`;
                    desc += ` Â· é¢˜ç›®ï¼š${selection.items.join(",")} Â· å‘½ä¸­çŸ¥è¯†ç‚¹ï¼š${insight.kp}`;
                }

                emitTask("student", {
                    id: taskId,
                    status: "todo",
                    studentId: sid,
                    title,
                    tag: "é”™é¢˜è®­ç»ƒ",
                    desc,
                    scenario: "student_mistake",
                    payload: {
                        source:"teacher_homework",
                        mode,
                        kps: (mode==="kp") ? selection.items : [],
                        errorTags: (mode==="tag") ? selection.items : [],
                        questions: (mode==="q") ? selection.questions : [],
                        topError: insight.topError,
                        className: insight.className,
                        teacherName: CONFIG.teacher.name
                    },
                    suggestedPrompt: buildSuggestedPromptForPush(mode, selection, insight)
                });
                count += 1;
            });

            closePushModal();

            // æ›´æ–°ç®¡ç†ç«¯/é©¾é©¶èˆ±æ¨¡æ‹Ÿç»Ÿè®¡ï¼ˆè¶‹åŠ¿ã€ç­çº§å¯¹æ¯”ï¼‰
            try { updateAdminAnalyticsOnPush(mode, selection, stus, insight.className); } catch(e){}

            showToast("æ¨é€æˆåŠŸ", `å·²æ¨é€ ${count} ä¸ªä»»åŠ¡ï¼ˆ${stus.length}åå­¦ç”Ÿï¼‰ã€‚`, [
                { label: "åˆ‡åˆ°å­¦ç”Ÿç«¯", primary: true, onClick: () => { APP_STATE.currentStudentId = stus[0]; changeStudent(stus[0]); } }
            ]);

            // å®¶é•¿ç«¯ï¼šå­¦ä¹ æé†’ï¼ˆæ›´è´´è¿‘ç°å®è”åŠ¨ï¼‰
            const child = getChildById(APP_STATE.currentChildId);
            const hint = mode==="kp" ? `è€å¸ˆæ¨é€äº†é”™é¢˜å·©å›ºï¼š${selection.items[0]}${selection.items.length>1?" ç­‰":""}`
                        : mode==="tag" ? `è€å¸ˆæ¨é€äº†é”™å› çº æ­£ï¼š${selection.items[0]}${selection.items.length>1?" ç­‰":""}`
                        : `è€å¸ˆæ¨é€äº†é”™é¢˜è®¢æ­£ï¼š${selection.items.slice(0,2).join(",")}${selection.items.length>2?"â€¦":""}`;

            emitTask("parent", {
                id: uid("task"),
                status: "todo",
                childId: child.id,
                title: "å­¦ä¹ æé†’ï¼šè€å¸ˆæ¨é€é”™é¢˜å·©å›º",
                tag: "å®¶æ ¡ååŒ",
                desc: `${hint}ã€‚å»ºè®®ä»Šæ™šå®‰æ’ 20â€“25 åˆ†é’Ÿå®Œæˆï¼Œå¹¶æé†’å­©å­æŒ‰â€œé”™å› â€å¤ç›˜ã€‚`,
                scenario: "parent_connect",
                payload: { mode, items: selection.items, className: insight.className }
            });

            // ç®¡ç†ç«¯ï¼šå­¦æƒ…æé†’ï¼ˆæ²»ç†è”åŠ¨ï¼‰
            emitTask("admin", {
                id: uid("task"),
                status: "todo",
                title: "å­¦æƒ…æé†’ï¼šå¹´çº§è–„å¼±ç‚¹è·Ÿè¸ª",
                tag: "æ•™å­¦æ²»ç†",
                desc: `åˆäºŒå¹´çº§å‡ºç°é›†ä¸­é”™å› /è–„å¼±ç‚¹ï¼Œå»ºè®®å…³æ³¨ï¼š${mode==="kp"?selection.items[0]:insight.kp}ï¼Œå¹¶è¿½è¸ªç­çº§å®Œæˆç‡ä¸æŒæ¡ç‡ã€‚`,
                scenario: "admin_activity",
                payload: { focus: mode==="kp"?selection.items[0]:insight.kp, mode }
            });
        }

        function buildSuggestedPromptForPush(mode, selection, insight){
            if (mode==="kp"){
                const kp = selection.items[0];
                return `è€å¸ˆæ¨é€äº†é”™é¢˜å·©å›ºï¼ˆçŸ¥è¯†ç‚¹ï¼š${selection.items.join("ã€")}ï¼‰ã€‚è¯·å…ˆç”¨ä¸€å¥è¯è®²æ¸…ã€Œ${kp}ã€æ ¸å¿ƒæ¦‚å¿µï¼Œå†æŒ‰â€œæ˜“â†’ä¸­â†’éš¾â€å‡º 3 é“åŒç±»é¢˜å¹¶ç»™å‡ºè‡ªæµ‹é¢˜ã€‚æœ€åæé†’æˆ‘æ€»ç»“é”™å› ã€‚`;
            }
            if (mode==="tag"){
                const tag = selection.items[0];
                return `è€å¸ˆæ¨é€äº†é”™å› çº æ­£ï¼ˆæ ‡ç­¾ï¼š${selection.items.join("ã€")}ï¼‰ã€‚è¯·å…ˆè§£é‡Šâ€œ${tag}â€é€šå¸¸æ€ä¹ˆé”™ï¼Œç„¶åç»™å‡º 2 ä¸ªé¿å…ç­–ç•¥ï¼›å†æä¾› 3 é“ç»ƒä¹ é¢˜ï¼ˆé€’è¿›ï¼‰å¹¶æç¤ºæˆ‘ç”¨ä¸€å¥è¯å¤ç›˜ã€‚`;
            }
            // q
            const q0 = selection.questions?.[0]?.id || "é¢˜ç›®";
            return `è€å¸ˆæ¨é€äº†é”™é¢˜è®¢æ­£ï¼ˆ${selection.items.join(",")}ï¼‰ã€‚è¯·å¼•å¯¼æˆ‘æŒ‰æ­¥éª¤è®¢æ­£ï¼šå…ˆå¤è¿°é¢˜æ„â†’åˆ—å¼â†’éªŒç®—â†’æ€»ç»“é”™å› ï¼›æœ€åç»™å‡º 1 é“åŒç±»å˜å¼é¢˜è‡ªæµ‹ã€‚`;
        }

function pushMistakePackage() {
            const insight = APP_STATE.lastHomeworkInsight;
            if (!insight) {
                showToast("æœªæ‰¾åˆ°ä½œä¸šæ´å¯Ÿ", "è¯·å…ˆè¿è¡Œã€Œä½œä¸šæ•°æ®åˆ†æã€åœºæ™¯ã€‚");
                return;
            }
            const taskId = uid("task");
            emitTask("student", {
                id: taskId,
                status: "todo",
                title: `é”™é¢˜çº æ­£ï¼š${insight.kp}`,
                tag: "é”™é¢˜è®­ç»ƒ",
                desc: `æ¥è‡ªæ•™å¸ˆæ¨é€ Â· é‡ç‚¹çº æ­£ï¼š${insight.topError}`,
                scenario: "student_mistake",
                payload: { source:"teacher_homework", kp: insight.kp, topError: insight.topError, className: insight.className },
                suggestedPrompt: `è€å¸ˆæ¨é€äº†é”™é¢˜ç»ƒä¹ åŒ…ï¼šè¯·å¸®æˆ‘æŠŠã€Œ${insight.kp}ã€çš„æ¦‚å¿µè®²æ˜ç™½ï¼Œå¹¶ç»™æˆ‘ 3 é“åŒç±»é¢˜ï¼ˆé€’è¿›ï¼‰ã€‚`
            });

            showToast("æ¨é€æˆåŠŸ", `å·²å‘å­¦ç”Ÿç«¯æ¨é€ã€Œ${insight.kp}ã€é”™é¢˜ç»ƒä¹ åŒ…ã€‚`, [
                { label: "åˆ‡åˆ°å­¦ç”Ÿç«¯", primary: true, onClick: () => switchRole("student") }
            ]);
        }

        function genReviewCourseware() {
            const insight = APP_STATE.lastHomeworkInsight;
            APP_STATE.pendingCtx = insight ? { source:"teacher_homework", ...insight } : null;
            document.getElementById('mainInput').value = insight
                ? `åŸºäºã€Œ${insight.kp}ã€é«˜é¢‘é”™å› ï¼Œä¸ºæˆ‘ç”Ÿæˆä¸€ä»½ 5 åˆ†é’Ÿè®²è¯„è¯¾ä»¶ï¼ˆæ¿ä¹¦ç»“æ„ + è®²è§£è¯æœ¯ + è¯¾å ‚æé—®ï¼‰ã€‚`
                : "ç”Ÿæˆè®²è¯„è¯¾ä»¶ï¼ˆ5åˆ†é’Ÿå¾®è®²è¯„ï¼‰";
            handleInput("teacher_review");
        }

        function reportStudentResultToTeacher() {
            const res = APP_STATE.lastStudentResult;
            if (!res) {
                showToast("æœªæ‰¾åˆ°ç»ƒä¹ ç»“æœ", "è¯·å…ˆå®Œæˆä¸€æ¬¡é”™é¢˜è®­ç»ƒã€‚");
                return;
            }
            const taskId = uid("task");
            emitTask("teacher", {
                id: taskId,
                status: "todo",
                title: `ç»ƒä¹ å›ä¼ ï¼š${res.kp}ï¼ˆæŒæ¡ç‡ ${res.mastery}%ï¼‰`,
                tag: "å›ä¼ ",
                desc: `å­¦ç”Ÿå·²å®Œæˆç»ƒä¹  Â· å»ºè®®ï¼š${res.suggestion}`,
                scenario: "teacher_followup",
                payload: { source:"student_mistake", kp: res.kp, mastery: res.mastery, suggestion: res.suggestion },
                suggestedPrompt: `æŸ¥çœ‹å­¦ç”Ÿã€Œ${res.kp}ã€ç»ƒä¹ å›ä¼ ï¼Œå¹¶ç”Ÿæˆä¸‹ä¸€æ­¥è®²è¯„ä¸åˆ†å±‚ä½œä¸šå»ºè®®ã€‚`
            });

            // é©¾é©¶èˆ±ç»Ÿè®¡ï¼šå®Œæˆå›ä¼ åï¼Œæå‡ç­çº§å®Œæˆç‡/æŒæ¡ç‡ï¼ˆæ¼”ç¤ºï¼‰
            try { updateAdminAnalyticsOnReturn(APP_STATE.lastHomeworkInsight?.className || "åˆäºŒ(3)ç­", (res.mastery>=85?0.035:0.025)); } catch(e){}


            showToast("å·²å›ä¼ æ•™å¸ˆ", `å·²å°†ã€Œ${res.kp}ã€ç»ƒä¹ ç»“æœå›ä¼ åˆ°æ•™å¸ˆç«¯ã€‚`, [
                { label: "åˆ‡åˆ°æ•™å¸ˆç«¯", primary: true, onClick: () => switchRole("teacher") }
            ]);
        }


        function addMsg(role, html) {
            const div = document.createElement('div');
            div.className = 'message';
            const color = CONFIG[currentRole].color;
            const icon = role === 'User' ? '<i class="ri-user-smile-line"></i>' : `<i class="ri-openai-fill" style="color:${color}"></i>`;
            div.innerHTML = `<div class="msg-head">${icon} ${role === 'User' ? 'You' : 'EduCore'}</div><div class="msg-body">${html}</div>`;
            document.getElementById('chatContainer').appendChild(div);
            scrollToBottom();
        }

        // === 3. æ·±åº¦åœºæ™¯æ¨¡æ‹Ÿå¼•æ“ (The Core) ===
        async function startDeepDive(type) {
            const container = document.getElementById('chatContainer');
            const thinkBox = document.createElement('div');
            thinkBox.className = 'thinking-box';
            container.appendChild(thinkBox);

            let steps = [];
            let summary = "";
            let artifactHTML = "";

            const ctx = consumePendingCtx() || {};

            // ================== TEACHER ==================
            if (type === 'teacher_lesson') {
                steps = ["åˆ†æè¯¾æ ‡ï¼šå…«å¹´çº§æ•°å­¦ä¸‹å†Œ / å‡ ä½•ç›´è§‚ / é€»è¾‘æ¨ç†", "æ£€ç´¢ç´ æåº“ï¼šæ¯•è¾¾å“¥æ‹‰æ–¯åœ°ç –ã€èµµçˆ½å¼¦å›¾ã€ä¹ç« ç®—æœ¯", "è®¾è®¡æ•™å­¦ç­–ç•¥ï¼šæƒ…å¢ƒå¯¼å…¥ -> æ¢ç©¶è¯æ˜(é¢ç§¯æ³•) -> å½’çº³åº”ç”¨", "æ„å»ºåˆ†å±‚èµ„æºï¼šAå±‚åŸºç¡€è®¡ç®— / Bå±‚å¤ç±å»ºæ¨¡åº”ç”¨", "æ¸²æŸ“æ•™å­¦è®¾è®¡å¡ç‰‡..."];
                summary = "æ•™æ¡ˆå·²ç”Ÿæˆã€‚é‡ç‚¹åˆ©ç”¨<b>â€œèµµçˆ½å¼¦å›¾â€</b>çªç ´æ•°å½¢ç»“åˆéš¾ç‚¹ã€‚";
                artifactHTML = `
                    <div class="card-header"><span style="font-weight:700; color:#9a3412">å‹¾è‚¡å®šç† (ç¬¬1è¯¾æ—¶)</span><span style="font-size:11px; color:#888">äººæ•™ç‰ˆ å…«å¹´çº§ä¸‹å†Œ</span></div>
                    <div class="card-body">
                        <div class="timeline">
                            <div class="t-box">å¯¼å…¥<br><span style="color:#999; font-size:10px">åœ°ç –è§„å¾‹</span></div>
                            <div class="t-box" style="border-color:var(--theme-color); background:#fff7ed">æ¢ç©¶<br><span style="color:#c2410c; font-size:10px">èµµçˆ½å¼¦å›¾</span></div>
                            <div class="t-box">ç»ƒä¹ <br><span style="color:#999; font-size:10px">åˆ†å±‚åº”ç”¨</span></div>
                        </div>
                        <div style="font-size:12px; font-weight:700; color:#aaa; margin:15px 0 5px 0;">ğŸ’¡ é‡éš¾ç‚¹çªç ´</div>
                        <div class="hl-box" style="border-left:3px solid var(--theme-color); background:#fff7ed; padding:10px;">åˆ©ç”¨å‡ ä½•ç”»æ¿å±•ç¤ºæœ±å®ä¸é»„å®æ‹¼æ¥ï¼Œæ¨å¯¼ $a^2+b^2=c^2$ã€‚</div>
                    </div>
                    <div class="card-actions"><button class="btn btn-primary">å­˜å…¥å¤‡è¯¾æœ¬</button></div>`;
            }
            else if (type === 'teacher_homework') {
                steps = ["è¿æ¥é˜…å·ç³»ç»Ÿ API...", "æŠ“å–å®¢è§‚é¢˜æ•°æ®ï¼šæ­£ç¡®ç‡ 78%", "ä¸»è§‚é¢˜è¯­ä¹‰åˆ†æï¼šå…³é”®è¯â€œæˆªè·å«ä¹‰â€ç¼ºå¤±", "ç”Ÿæˆç­çº§å­¦æƒ…å›¾è¡¨..."];
                summary = "æ˜¨æ—¥ä½œä¸šåˆ†æå·²å®Œæˆã€‚æ•´ä½“è¡¨ç°è‰¯å¥½ï¼Œä½†<b>â€œä¸€æ¬¡å‡½æ•°æˆªè·â€</b>æ¦‚å¿µå­˜åœ¨æ™®éè®¤çŸ¥åå·®ã€‚";
                // é“¾è·¯Aï¼šå°†æœ¬æ¬¡ä½œä¸šæ´å¯Ÿå†™å…¥çŠ¶æ€ï¼ˆä¾›â€œæ¨é€é”™é¢˜ç»ƒä¹ åŒ…â€ä½¿ç”¨ï¼‰
                APP_STATE.lastHomeworkInsight = {
                    className: "åˆäºŒ(3)ç­",
                    kp: "ä¸€æ¬¡å‡½æ•°æˆªè·",
                    topError: "æ¦‚å¿µç†è§£ç¼ºå¤±ï¼šæˆªè·å«ä¹‰ä¸å›¾åƒäº¤ç‚¹å¯¹åº”å…³ç³»",
                    focusStudents: ["ææ˜", "å¼ ä¼Ÿ", "ç‹èŠ³", "é™ˆæµ©"],
                    // é”™å› æ ‡ç­¾ï¼ˆæ¼”ç¤ºæ›´è´´è¿‘çœŸå®ï¼šå¯æŒ‰é”™å› æ¨é€ï¼‰
                    errorTags: [
                        { tag:"æ¦‚å¿µæ··æ·†", count:18, desc:"æŠŠâ€œæˆªè·â€å½“ä½œæ–œç‡/å¢é‡ï¼Œæœªå»ºç«‹â€œä¸åæ ‡è½´äº¤ç‚¹â€å¯¹åº”å…³ç³»" },
                        { tag:"å®¡é¢˜åå·®", count:12, desc:"å¿½ç•¥â€œç»è¿‡ç‚¹/ä¸åæ ‡è½´äº¤ç‚¹â€æ¡ä»¶ï¼Œç›´æ¥å¥—å…¬å¼" },
                        { tag:"è®¡ç®—å¤±è¯¯", count:9,  desc:"ä»£å…¥æ±‚ b æ—¶ç¬¦å·é”™è¯¯æˆ–ç§»é¡¹é”™è¯¯" }
                    ],
                    // é¢˜ç›®æ ·ä¾‹åº“ï¼ˆæ¼”ç¤ºï¼šå¯æŒ‰é¢˜ç›®æ¨é€è®¢æ­£ï¼‰
                    questionBank: [
                        {
                            id:"Q5",
                            kp:"ä¸€æ¬¡å‡½æ•°æˆªè·",
                            tag:"æ¦‚å¿µæ··æ·†",
                            stem:"å·²çŸ¥ä¸€æ¬¡å‡½æ•° y = 2x + b ç»è¿‡ç‚¹ (1,5)ï¼Œæ±‚ b çš„å€¼ï¼Œå¹¶è¯´æ˜ b çš„å‡ ä½•æ„ä¹‰ã€‚",
                            answer:"b = 3ï¼›b è¡¨ç¤º y è½´æˆªè·ï¼Œå³å›¾åƒä¸ y è½´äº¤ç‚¹çš„çºµåæ ‡ã€‚",
                            keySteps:["ä»£å…¥ç‚¹(1,5)å¾— 5=2*1+b","æ±‚å¾— b=3","è¯´æ˜ï¼šæˆªè·å¯¹åº”ä¸ y è½´äº¤ç‚¹ (0,b)"]
                        },
                        {
                            id:"Q9",
                            kp:"ä¸€æ¬¡å‡½æ•°æˆªè·",
                            tag:"å®¡é¢˜åå·®",
                            stem:"ä¸€æ¬¡å‡½æ•° y = kx + b çš„å›¾åƒä¸ y è½´äº¤äºç‚¹ (0,-2)ï¼Œä¸ç‚¹ (2,2) è¿‡åŒä¸€ç›´çº¿ï¼Œæ±‚è§£æå¼ã€‚",
                            answer:"y = 2x - 2",
                            keySteps:["ç”±æˆªè·å¾— b=-2","ä»£å…¥ç‚¹(2,2)ï¼š2=2k-2","æ±‚ k=2ï¼Œå¾— y=2x-2"]
                        },
                        {
                            id:"Q12",
                            kp:"ä¸€æ¬¡å‡½æ•°æˆªè·",
                            tag:"è®¡ç®—å¤±è¯¯",
                            stem:"è‹¥ç›´çº¿ y = -x + b ç»è¿‡ç‚¹ (-3,1)ï¼Œæ±‚ bã€‚",
                            answer:"b = -2",
                            keySteps:["ä»£å…¥ï¼š1 = -(-3) + b","1 = 3 + b","b = -2"]
                        }
                    ],
                    recommend: ["ç”¨å›¾åƒç›´è§‚è§£é‡Šæˆªè·", "3 é“åŒç±»é¢˜é€’è¿›è®­ç»ƒ", "è¯¾å ‚ 5 åˆ†é’Ÿå¾®è®²è¯„"]
                };

                artifactHTML = `
                    <div class="card-header"><span style="font-weight:700;">ğŸ“‰ ä½œä¸šå­¦æƒ…çœ‹æ¿</span><span style="font-size:11px; color:#888">åˆäºŒ(3)ç­</span></div>
                    <div class="card-body">
                        <div class="stat-grid" style="margin-bottom:15px;">
                            <div class="stat-box"><div class="stat-val" style="color:#f97316">82.5</div><div class="stat-lbl">å¹³å‡åˆ†</div></div>
                            <div class="stat-box"><div class="stat-val">98%</div><div class="stat-lbl">æäº¤ç‡</div></div>
                            <div class="stat-box"><div class="stat-val" style="color:#ef4444">Q5</div><div class="stat-lbl">é«˜é¢‘é”™é¢˜</div></div>
                        </div>
                        <div style="font-size:12px; color:#666;">åˆ†æ•°æ®µåˆ†å¸ƒ</div>
                        <div class="bar-chart">
                            <div class="bar" style="height:30%"><span>C</span></div>
                            <div class="bar" style="height:60%"><span>B</span></div>
                            <div class="bar" style="height:80%"><span>A</span></div>
                            <div class="bar" style="height:40%"><span>S</span></div>
                        </div>
                    </div>
                    <div class="card-actions" style="display:flex; gap:10px; flex-wrap:wrap;"><button class="btn btn-primary" onclick="openPushModal()">é…ç½®å¹¶æ¨é€ç»ƒä¹ åŒ…</button><button class="btn" style="border:1px solid #e5e7eb; background:#fff;" onclick="pushMistakePackage()">ä¸€é”®æ¨é€ï¼ˆé»˜è®¤ï¼‰</button><button class="btn" style="border:1px solid #e5e7eb; background:#fff;" onclick="genReviewCourseware()">ç”Ÿæˆè®²è§£è¯¾ä»¶</button></div>`;
            }
            
            else if (type === 'teacher_review') {
                const kp = ctx.kp || "ä¸€æ¬¡å‡½æ•°æˆªè·";
                steps = [
                    "è¯»å–é”™å› èšç±»ç»“æœï¼ˆæ¥è‡ªä½œä¸šåˆ†æï¼‰...",
                    "é€‰æ‹©è®²è¯„ç­–ç•¥ï¼šæ¦‚å¿µæ¾„æ¸… + å›¾åƒç›´è§‚ + é€’è¿›ç»ƒä¹ ",
                    "ç”Ÿæˆæ¿ä¹¦ç»“æ„ä¸è®²è§£è¯æœ¯ï¼ˆ5åˆ†é’Ÿï¼‰",
                    "ç”Ÿæˆè¯¾å ‚æé—®ä¸å³æ—¶åé¦ˆé¢˜"
                ];
                summary = `è®²è¯„è¯¾ä»¶å·²ç”Ÿæˆï¼Œé‡ç‚¹çº æ­£<b>ã€Œ${kp}ã€</b>æ¦‚å¿µåå·®ï¼Œé€‚é… 5 åˆ†é’Ÿè¯¾å ‚å¾®è®²è¯„ã€‚`;
                artifactHTML = `
                    <div class="card-header"><span style="font-weight:700;">ğŸ§© 5åˆ†é’Ÿè®²è¯„è¯¾ä»¶</span><span style="font-size:11px; color:#888">${ctx.className || "ç­çº§"}</span></div>
                    <div class="card-body">
                        <div style="font-weight:650; margin-bottom:8px;">â‘  æ¿ä¹¦ç»“æ„ï¼ˆå»ºè®®ï¼‰</div>
                        <div style="font-size:12px; color:#555; line-height:1.5; background:#f9fafb; border:1px solid #eee; padding:10px; border-radius:12px;">
                            <div><b>1.</b> æˆªè·æ˜¯ä»€ä¹ˆï¼Ÿ â†’ ç›´è§‚ï¼šå›¾åƒä¸ <b>yè½´äº¤ç‚¹</b></div>
                            <div><b>2.</b> å…¬å¼ä½ç½®ï¼šy = kx + b ä¸­çš„ <b>b</b></div>
                            <div><b>3.</b> å¦‚ä½•ä»é¢˜ç›®è¯»å‡ºæˆªè· â†’ ä»£å…¥ x=0</div>
                            <div><b>4.</b> å³æ—¶å°æµ‹ï¼šåˆ¤æ–­/å¡«ç©ºï¼ˆ30ç§’ï¼‰</div>
                        </div>

                        <div style="font-weight:650; margin:12px 0 8px;">â‘¡ è®²è§£è¯æœ¯ï¼ˆç²¾ç®€ï¼‰</div>
                        <div style="font-size:12px; color:#555; line-height:1.5;">
                            â€œæˆªè·ä¸æ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ•°å­—ï¼Œå®ƒåœ¨å›¾ä¸Šå°±æ˜¯ yè½´äº¤ç‚¹çš„åæ ‡ã€‚æŠŠ <b>x=0</b> å¸¦å…¥ï¼Œå°±èƒ½å¿«é€Ÿæ‰¾åˆ° bã€‚â€
                        </div>

                        <div style="font-weight:650; margin:12px 0 8px;">â‘¢ è¯¾å ‚æé—®ï¼ˆå³æ—¶æ£€æŸ¥ï¼‰</div>
                        <div class="mistake-split" style="grid-template-columns:1fr 1fr;">
                            <div class="mistake-left"><strong style="display:block; margin-bottom:6px;">å¿«é€Ÿåˆ¤æ–­</strong>
                                <span style="font-size:12px">y = 2x - 3 çš„æˆªè·æ˜¯å¤šå°‘ï¼Ÿå›¾ä¸Šåœ¨å“ªé‡Œï¼Ÿ</span>
                            </div>
                            <div class="mistake-right"><strong style="display:block; margin-bottom:6px;">è¿ç§»åº”ç”¨</strong>
                                <span style="font-size:12px">å·²çŸ¥æˆªè·ä¸º 4ï¼Œä¸”è¿‡ç‚¹(2,7)ï¼Œæ±‚è§£æå¼ã€‚</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-actions" style="display:flex; gap:10px; flex-wrap:wrap;">
                        <button class="btn btn-primary" onclick="pushMistakePackage()">åŒæ­¥å­¦ç”Ÿç»ƒä¹ åŒ…</button>
                        <button class="btn" style="border:1px solid #e5e7eb; background:#fff;" onclick="addMsg('EduCore','å·²å­˜å…¥ã€è®²è¯„è¯¾ä»¶åº“ã€‘ï¼ˆæ¨¡æ‹Ÿï¼‰ã€‚')">å­˜æ¡£åˆ°è¯¾ä»¶åº“</button>
                    </div>`;
            }

            else if (type === 'teacher_paper') {
                steps = ["æ£€ç´¢çŸ¥ç½‘/ä¸‡æ–¹æ•°æ®åº“...", "åˆ†æè¿‘3å¹´çƒ­ç‚¹ï¼šæ•°å½¢ç»“åˆ / ä¿¡æ¯åŒ–èåˆ", "ç”Ÿæˆé€‰é¢˜æ¨è", "æ¢³ç†æ ¸å¿ƒå‚è€ƒæ–‡çŒ®"];
                summary = "ä¸ºæ‚¨æ¨è 3 ä¸ªå…·æœ‰åˆ›æ–°æ€§çš„é€‰é¢˜æ–¹å‘ï¼Œå¹¶å·²æ¢³ç†ç›¸å…³æ ¸å¿ƒæ–‡çŒ®ã€‚";
                artifactHTML = `
                    <div class="card-header"><span style="font-weight:700;">ğŸ“‘ è®ºæ–‡é€‰é¢˜æ¨è</span></div>
                    <div class="card-body">
                        <div class="list-item">
                            <div><strong>é€‰é¢˜ Aï¼š</strong> åŸºäº GeoGebra çš„æ•°å½¢ç»“åˆåŠ¨æ€æ•™å­¦å®è·µç ”ç©¶</div>
                            <span class="tag tag-green">çƒ­åº¦é«˜</span>
                        </div>
                        <div class="list-item">
                            <div><strong>é€‰é¢˜ Bï¼š</strong> â€œåŒå‡â€èƒŒæ™¯ä¸‹åˆä¸­æ•°å­¦åˆ†å±‚ä½œä¸šè®¾è®¡ç­–ç•¥</div>
                            <span class="tag tag-blue">æ”¿ç­–å‘</span>
                        </div>
                        <div style="margin-top:15px; padding:10px; background:#f9fafb; border-radius:8px; font-size:12px; color:#666;">
                            <strong>ğŸ“š æ ¸å¿ƒæ–‡çŒ®ï¼š</strong><br>
                            1. ç‹å°šå¿—. æ•°å­¦æ ¸å¿ƒç´ å…»çš„å†…æ¶µ... <br>
                            2. å¼ å¥ å®™. æ•°å­¦æ•™è‚²å­¦å¯¼è®º...
                        </div>
                    </div>
                    <div class="card-actions"><button class="btn btn-primary">ç”Ÿæˆé€‰é¢˜å¤§çº²</button></div>`;
            }

            
            else if (type === 'teacher_followup') {
                const kp = (ctx && ctx.kp) ? ctx.kp : "ä¸€æ¬¡å‡½æ•°æˆªè·";
                const mastery = (ctx && ctx.mastery) ? ctx.mastery : 86;
                steps = [
                    "è¯»å–å­¦ç”Ÿç»ƒä¹ å›ä¼ ç»“æœ...",
                    "å¯¹æ¯”å‰æµ‹/åæµ‹æŒæ¡åº¦å˜åŒ–",
                    "ç”Ÿæˆåˆ†å±‚å·©å›ºå»ºè®®ï¼ˆA/B/Cï¼‰",
                    "ç”Ÿæˆä¸‹ä¸€æ¬¡ä½œä¸šå¸ƒç½®ä¸è®²è¯„å®‰æ’"
                ];
                summary = `å­¦ç”Ÿç»ƒä¹ å·²å›ä¼ ï¼š<b>${kp}</b> å½“å‰æŒæ¡ç‡ <b>${mastery}%</b>ã€‚å»ºè®®è¿›è¡Œ 1 æ¬¡è½»é‡å·©å›ºã€‚`;
                artifactHTML = `
                    <div class="card-header"><span style="font-weight:700;">âœ… ç»ƒä¹ å›ä¼ ä¸å·©å›ºå»ºè®®</span><span style="font-size:11px; color:#888">æ•™å¸ˆç«¯</span></div>
                    <div class="card-body">
                        <div class="stat-grid" style="margin-bottom:15px;">
                            <div class="stat-box"><div class="stat-val" style="color:#10b981">${mastery}%</div><div class="stat-lbl">æŒæ¡ç‡</div></div>
                            <div class="stat-box"><div class="stat-val">+12%</div><div class="stat-lbl">æå‡</div></div>
                            <div class="stat-box"><div class="stat-val" style="color:#f97316">3é¢˜</div><div class="stat-lbl">å»ºè®®å·©å›º</div></div>
                        </div>
                        <div style="font-weight:650; margin-bottom:8px;">åˆ†å±‚å·©å›ºï¼ˆæ¨èï¼‰</div>
                        <div style="font-size:12px; color:#555; line-height:1.5; background:#f9fafb; border:1px solid #eee; padding:10px; border-radius:12px;">
                            <div><b>Aå±‚</b>ï¼ˆå…¨ç­ï¼‰ï¼š1 é“åˆ¤æ–­ + 1 é“ä»£å…¥é¢˜ï¼ˆx=0ï¼‰</div>
                            <div><b>Bå±‚</b>ï¼ˆé‡ç‚¹ç”Ÿï¼‰ï¼š1 é“è§£æå¼åæ¨é¢˜</div>
                            <div><b>Cå±‚</b>ï¼ˆè¡¥å¼±ï¼‰ï¼šå›¾åƒå®šä½æˆªè· + å£å¤´å¤è¿°æ¦‚å¿µ</div>
                        </div>
                    </div>
                    <div class="card-actions" style="display:flex; gap:10px; flex-wrap:wrap;">
                        <button class="btn btn-primary" onclick="addMsg('EduCore','å·²ç”Ÿæˆå¹¶ä¸‹å‘ã€åˆ†å±‚å·©å›ºä½œä¸šã€‘ï¼ˆæ¨¡æ‹Ÿï¼‰ã€‚')">ä¸‹å‘å·©å›ºä½œä¸š</button>
                        <button class="btn" style="border:1px solid #e5e7eb; background:#fff;" onclick="genReviewCourseware()">å†è®²ä¸€æ¬¡ï¼ˆ5åˆ†é’Ÿï¼‰</button>
                    </div>`;
            }

            // ================== STUDENT ==================
            
else if (type === 'student_mistake') {
                const mode = ctx.mode || (ctx.questions && ctx.questions.length ? "q" : (ctx.errorTags && ctx.errorTags.length ? "tag" : "kp"));
                const focusKp = (ctx.kps && ctx.kps.length) ? ctx.kps[0] : (ctx.questions && ctx.questions[0] ? ctx.questions[0].kp : (ctx.kp || "äºŒæ¬¡å‡½æ•°æœ€å€¼"));
                const tags = (ctx.errorTags || []);
                const kps = (ctx.kps || (ctx.kp?[ctx.kp]:[]));
                const questions = (ctx.questions || []);

                const chip = (t, tone="neutral") => {
                    const bg = tone==="warn" ? "#fff7ed" : tone==="ok" ? "#ecfdf5" : "#f3f4f6";
                    const bd = tone==="warn" ? "#fed7aa" : tone==="ok" ? "#a7f3d0" : "#e5e7eb";
                    const tx = tone==="warn" ? "#9a3412" : tone==="ok" ? "#065f46" : "#374151";
                    return `<span style="display:inline-flex; align-items:center; padding:4px 8px; border-radius:999px; border:1px solid ${bd}; background:${bg}; color:${tx}; font-size:12px; font-weight:650; margin-right:6px; margin-bottom:6px;">${t}</span>`;
                };

                let modeLabel = mode==="kp" ? "çŸ¥è¯†ç‚¹å·©å›º" : (mode==="tag" ? "é”™å› çº æ­£" : "é¢˜ç›®è®¢æ­£");
                steps = [
                    "è¯»å–æ•™å¸ˆæ¨é€ä¸Šä¸‹æ–‡...",
                    `ç¡®å®šè®­ç»ƒæ¨¡å¼ï¼š${modeLabel}`,
                    `å®šä½çŸ¥è¯†ç‚¹ï¼š${focusKp}`,
                    "ç”Ÿæˆâ€œçº é”™ç­–ç•¥ + ç»ƒä¹ /è®¢æ­£ + è‡ªæµ‹â€",
                    "è®°å½•å®Œæˆæƒ…å†µå¹¶å¯å›ä¼ æ•™å¸ˆ"
                ];

                let summarySuffix = ctx.teacherName ? `ï¼ˆæ¥æºï¼š${ctx.teacherName}è€å¸ˆæ¨é€ï¼‰` : "";
                summary = `æœ¬æ¬¡ä»»åŠ¡ï¼š<b>${modeLabel}</b>ï¼Œèšç„¦<b>ã€Œ${focusKp}ã€</b>ã€‚å®Œæˆåå°†ç”ŸæˆæŒæ¡ç‡å¹¶å›ä¼ è€å¸ˆç”¨äºåˆ†å±‚å·©å›ºã€‚${summarySuffix}`;

                // è®°å½•ç»ƒä¹ ç»“æœï¼ˆç”¨äºå›ä¼ æ•™å¸ˆï¼‰
                const mastery = Math.floor(76 + Math.random()*18);
                APP_STATE.lastStudentResult = {
                    kp: focusKp,
                    mastery,
                    className: ctx.className || "åˆäºŒ(3)ç­",
                    mode,
                    items: mode==="kp" ? kps : (mode==="tag" ? tags : questions.map(q=>q.id)),
                    suggestion: mode==="kp"
                        ? "å»ºè®®è¡¥åš 1 é“â€œç”±å›¾åƒè¯»æˆªè·â€å˜å¼é¢˜ï¼Œå·©å›ºæˆªè·ä¸åæ ‡è½´äº¤ç‚¹å¯¹åº”å…³ç³»"
                        : mode==="tag"
                            ? "å»ºè®®æŒ‰é”™å› æ ‡ç­¾å¤ç›˜ï¼šå…ˆå¤è¿°é¢˜æ„â†’å†å†™å…³é”®å¯¹åº”å…³ç³»â†’æœ€åéªŒç®—"
                            : "å»ºè®®ç”¨â€œå¤è¿°é¢˜æ„â†’åˆ—å¼â†’éªŒç®—â†’æ€»ç»“é”™å› â€å››æ­¥æ³•å†è®¢æ­£ä¸€æ¬¡"
                };

                const chipsHTML = `
                    <div style="margin:10px 0 2px;">
                        ${mode==="kp" ? kps.map(x=>chip("çŸ¥è¯†ç‚¹ï¼š"+x, "ok")).join("") : ""}
                        ${mode==="tag" ? tags.map(x=>chip("é”™å› ï¼š"+x, "warn")).join("") : ""}
                        ${mode==="q" ? questions.map(q=>chip(q.id+" Â· "+q.tag, "neutral")).join("") : ""}
                    </div>
                `;

                let mainHTML = "";
                if (mode === "q" && questions.length){
                    mainHTML = `
                        <div style="margin-top:10px; border-top:1px solid #eef2f7; padding-top:10px;">
                            <div style="font-weight:750; margin-bottom:8px;">é¢˜ç›®è®¢æ­£ï¼ˆ${questions.length}é¢˜ï¼‰</div>
                            ${questions.map(q=>`
                                <div style="border:1px solid #e5e7eb; background:#fff; border-radius:14px; padding:12px; margin-bottom:10px;">
                                    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                                        <div style="font-weight:850;">${q.id} <span style="font-weight:650; color:#6b7280;">Â· ${q.kp}</span></div>
                                        <span style="font-size:12px; color:#6b7280;">é”™å› æ ‡ç­¾ï¼š${q.tag}</span>
                                    </div>
                                    <div style="font-size:12px; color:#374151; margin:8px 0 10px; line-height:1.5;">${q.stem}</div>
                                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                                        <div style="background:#f9fafb; border:1px solid #eef2f7; border-radius:12px; padding:10px;">
                                            <div style="font-size:12px; font-weight:750; margin-bottom:6px;">æˆ‘æ¥è®¢æ­£ï¼ˆå†™å…³é”®æ­¥éª¤ï¼‰</div>
                                            <textarea style="width:100%; height:70px; border:1px solid #e5e7eb; border-radius:10px; padding:8px; font-size:12px;" placeholder="å¤è¿°é¢˜æ„â†’åˆ—å¼â†’è®¡ç®—â†’éªŒç®—"></textarea>
                                        </div>
                                        <div style="background:#ecfeff; border:1px solid #a5f3fc; border-radius:12px; padding:10px;">
                                            <div style="font-size:12px; font-weight:750; margin-bottom:6px;">å‚è€ƒè¦ç‚¹ï¼ˆæç¤ºï¼‰</div>
                                            <ul style="margin:0; padding-left:16px; font-size:12px; color:#0f172a; line-height:1.5;">
                                                ${ (q.keySteps||[]).slice(0,3).map(s=>`<li>${s}</li>`).join("")}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            `).join("")}
                            <div style="font-size:12px; color:#6b7280;">æç¤ºï¼šè®¢æ­£åè¯·ç”¨ä¸€å¥è¯å†™å‡ºâ€œæˆ‘ä¸ºä»€ä¹ˆé”™â€ï¼Œå†å›ä¼ è€å¸ˆã€‚</div>
                        </div>
                    `;
                } else {
                    const point = mode==="tag" ? (tags[0] || "æ¦‚å¿µæ··æ·†") : "æˆªè· b çš„å‡ ä½•æ„ä¹‰ï¼ˆä¸ y è½´äº¤ç‚¹ï¼‰";
                    const fix = mode==="tag" ? "å…ˆå¤è¿°é¢˜æ„â†’æ ‡æ³¨æ¡ä»¶â†’å†™å¯¹åº”å…³ç³»â†’å†åˆ—å¼éªŒç®—" : "å…ˆä»å›¾åƒ/äº¤ç‚¹ç†è§£ï¼Œå†ä»£å…¥æ±‚ bï¼Œæœ€åç”¨ (0,b) éªŒè¯";
                    mainHTML = `
                        <div class="mistake-split">
                            <div class="mistake-left">
                                <strong style="color:#ef4444">âŒ ä½ çš„å¡ç‚¹</strong><br>
                                <span style="font-size:12px">${mode==="tag" ? ("å…¸å‹é”™å› ï¼š"+point) : ("æŠŠâ€œæˆªè· bâ€è¯¯å½“æˆâ€œæ–œç‡ kâ€ï¼Œå¿½ç•¥å›¾åƒä¸ y è½´äº¤ç‚¹ã€‚")}</span>
                            </div>
                            <div class="mistake-right">
                                <strong style="color:#047857">âœ… çº é”™ç­–ç•¥</strong><br>
                                <span style="font-size:12px">${fix}</span>
                            </div>
                        </div>

                        <div class="practice-box">
                            <div class="practice-title">é€’è¿›ç»ƒä¹ ï¼ˆç¤ºä¾‹ï¼‰</div>
                            <ol class="practice-list">
                                <li>å·²çŸ¥ y = 3x + b ç»è¿‡ (2,7)ï¼Œæ±‚ bï¼Œå¹¶å†™å‡ºæˆªè·å¯¹åº”çš„ç‚¹ã€‚</li>
                                <li>ç›´çº¿ä¸ y è½´äº¤ç‚¹ä¸º (0,-1)ï¼Œä¸”è¿‡ç‚¹ (1,1)ï¼Œæ±‚è§£æå¼ã€‚</li>
                                <li>ç»™å‡ºä¸¤ç‚¹ (0,b)ã€(2,3)ï¼Œå†™å‡ºå‡½æ•°å¼å¹¶åˆ¤æ–­ b çš„å˜åŒ–å¯¹å›¾åƒçš„å½±å“ã€‚</li>
                            </ol>
                            <div style="margin-top:8px; font-size:12px; color:#6b7280;">å®Œæˆåå›ä¼ è€å¸ˆï¼šç³»ç»Ÿå°†ç»™å‡ºæŒæ¡ç‡ï¼ˆæ¨¡æ‹Ÿï¼‰å¹¶ç”Ÿæˆåˆ†å±‚å·©å›ºå»ºè®®ã€‚</div>
                        </div>
                    `;
                }

                artifactHTML = `
                    <div class="card-header"><span style="font-weight:800; color:#1e40af">ğŸ“ é”™é¢˜è®­ç»ƒä»»åŠ¡</span><span style="font-size:11px; color:#6b7280;">${modeLabel}</span></div>
                    <div class="card-body">
                        ${chipsHTML}
                        ${mainHTML}
                    </div>
                    <div class="card-actions" style="display:flex; gap:10px; flex-wrap:wrap;">
                        <button class="btn btn-primary" onclick="reportStudentResultToTeacher()">å®Œæˆå¹¶å›ä¼ è€å¸ˆ</button>
                        <button class="btn" style="border:1px solid #e5e7eb; background:#fff;" onclick="addMsg('EduCore','å·²å°†æœ¬æ¬¡ä»»åŠ¡åŠ å…¥ã€é”™é¢˜æœ¬ã€‘ï¼ˆæ¨¡æ‹Ÿï¼‰ã€‚')">åŠ å…¥é”™é¢˜æœ¬</button>
                    </div>`;
            }
else if (type === 'student_english') {
                steps = ["åŠ è½½åœºæ™¯ï¼šAirport Check-in", "åˆå§‹åŒ– AI è§’è‰²ï¼šGround Staff", "å¼€å¯è¯­éŸ³è¯†åˆ«å¼•æ“...", "ç”Ÿæˆå¼€åœºç™½"];
                summary = "Scene loaded. You are at the check-in counter. I am ready to help you.";
                artifactHTML = `
                    <div class="card-header"><span style="font-weight:700;">âœˆï¸ Airport Roleplay</span><span class="tag tag-blue">Speaking</span></div>
                    <div class="card-body">
                        <div style="background:#f9fafb; padding:15px; border-radius:8px; height:150px; overflow-y:auto;">
                            <div class="chat-bubble bubble-ai">Good morning. May I see your passport and ticket, please?</div>
                            <div class="chat-bubble bubble-user">Here they are. I'd like a window seat.</div>
                            <div class="chat-bubble bubble-ai">Sure. Do you have any luggage to check in?</div>
                        </div>
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <button class="btn" style="flex:1; justify-content:center;"><i class="ri-mic-line"></i> æŒ‰ä½è¯´è¯</button>
                        </div>
                    </div>`;
            }
            else if (type === 'student_preview') {
                steps = ["åˆ†æè¯¾è¡¨ï¼šæ˜æ—¥æœ‰ç‰©ç†ã€æ•°å­¦ã€è‹±è¯­", "å®šä½é‡ç‚¹ï¼šç‰©ç†å…«ä¸‹ã€Šå…‰çš„æŠ˜å°„ã€‹", "æ£€ç´¢èµ„æºï¼š3D å…‰è·¯æ¼”ç¤ºè§†é¢‘ + å¯¼å­¦æ¡ˆ", "ç”Ÿæˆè®¡åˆ’æ¸…å•"];
                summary = "å·²ä¸ºä½ ç”Ÿæˆæ˜æ—¥é¢„ä¹ è®¡åˆ’ã€‚é‡ç‚¹æ”»å…‹ç‰©ç†<b>â€œå…‰çš„æŠ˜å°„â€</b>å…‰è·¯å›¾ç”»æ³•ã€‚";
                artifactHTML = `
                    <div class="card-header"><span style="font-weight:700;">ğŸ“… æ˜æ—¥é¢„ä¹ æ¸…å•</span><span style="font-size:11px; color:#888">åˆäºŒç‰©ç†é‡ç‚¹</span></div>
                    <div class="card-body">
                        <div class="list-item">
                            <div><strong style="color:#1d4ed8">1. ç‰©ç† (15min)</strong><br><span style="font-size:12px">è§‚çœ‹ã€Šå…‰è·¯å¯é€†åŸç†ã€‹3Dæ¼”ç¤º</span></div>
                            <span class="tag tag-orange">å¿…åš</span>
                        </div>
                        <div class="list-item">
                            <div><strong>2. æ•°å­¦ (10min)</strong><br><span style="font-size:12px">æµè§ˆã€Šå‹¾è‚¡å®šç†ã€‹æ•™æä¾‹é¢˜</span></div>
                            <span class="tag tag-green">æµè§ˆ</span>
                        </div>
                        <div style="margin-top:10px; background:#eff6ff; padding:10px; border-radius:8px; font-size:13px; color:#1e40af;">
                            â–¶ï¸ <strong>è§†é¢‘èµ„æºå·²å°±ç»ªï¼š</strong> ç‚¹å‡»å¼€å§‹æ’­æ”¾
                        </div>
                    </div>
                    <div class="card-actions"><button class="btn btn-primary">å¼€å§‹é¢„ä¹ </button></div>`;
            }

            // ================== PARENT ==================
            else if (type === 'parent_report') {
                steps = ["èšåˆæ•™åŠ¡æˆç»©æ•°æ®", "åŒæ­¥ä½“è´¨ç›‘æµ‹æ‰‹ç¯æ•°æ®", "æå–ç»¼åˆç´ å…»è¯„ä»·", "ç”Ÿæˆäº”ç»´é›·è¾¾å›¾"];
                summary = "ææ˜æœ¬å‘¨<b>å­¦ä¸šè¡¨ç°ç¨³å®š</b>ï¼Œ<b>ä½“è´¨å¥åº·</b>å¾—åˆ†æ˜¾è‘—æå‡ï¼Œé˜…è¯»é‡éœ€åŠ å¼ºã€‚";
                artifactHTML = `
                    <div class="card-header"><span style="font-weight:700; color:#065f46">ğŸ“ˆ æœ¬å‘¨æˆé•¿æŠ¥å‘Š</span><span style="font-size:11px; color:#888">ç¬¬12å‘¨</span></div>
                    <div class="card-body">
                        <div style="display:flex; justify-content:center; margin:15px 0;">
                            <div style="width:120px; height:120px; background:conic-gradient(#10b981 0% 70%, #ecfdf5 70% 100%); border-radius:50%; position:relative;">
                                <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-weight:700;">A</div>
                            </div>
                        </div>
                        <div class="stat-grid">
                            <div class="stat-box"><div class="stat-val">92</div><div class="stat-lbl">å­¦ä¸š</div></div>
                            <div class="stat-box"><div class="stat-val" style="color:#10b981">Top 10%</div><div class="stat-lbl">ä½“è´¨</div></div>
                            <div class="stat-box"><div class="stat-val">3æœ¬</div><div class="stat-lbl">é˜…è¯»</div></div>
                        </div>
                    </div>
                    <div class="card-actions" style="display:flex; gap:10px; flex-wrap:wrap;"><button class="btn btn-primary" onclick="prefillAndRun('parent_connect', 'åŸºäºæœ¬å‘¨å‘¨æŠ¥ï¼Œè¯·å¸®æˆ‘ç”Ÿæˆä¸€æ¡ç»“æ„åŒ–æ²Ÿé€šå•ç»™ç­ä¸»ä»»/ä»»è¯¾è€å¸ˆï¼šåŒ…å«æˆ‘è§‚å¯Ÿåˆ°çš„é—®é¢˜ã€æˆ‘å¸Œæœ›ç¡®è®¤çš„ç‚¹ã€æˆ‘å°†é…åˆçš„è¡ŒåŠ¨ã€‚')">ç”Ÿæˆæ²Ÿé€šå•</button><button class="btn" style="border:1px solid #e5e7eb; background:#fff;" onclick="prefillAndRun('parent_edu', 'è¯·åŸºäºæœ¬å‘¨æ•°æ®ï¼Œç»™æˆ‘ä¸€ä¸ª7å¤©å®¶åº­é™ªä¼´ä¸å­¦ä¹ ä¹ æƒ¯è®¡åˆ’ï¼ˆæ¯å¤©15-20åˆ†é’Ÿï¼‰ï¼Œé‡ç‚¹é’ˆå¯¹è–„å¼±é¡¹ã€‚')">ç”Ÿæˆ7å¤©å®¶åº­è®¡åˆ’</button></div>`;
            }
            else if (type === 'parent_connect') {
                steps = ["æŸ¥è¯¢å­¦ä¸šè¿›åº¦æ•°æ®åº“", "æ‰«æè€ƒå‹¤ä¸è¯¾å ‚è¡¨ç°", "æ£€æµ‹å¼‚å¸¸æŒ‡æ ‡", "ç”Ÿæˆé¢„è­¦æ‘˜è¦"];
                summary = "æœ¬å‘¨å­¦ä¸šè¿›åº¦æ­£å¸¸ã€‚æ£€æµ‹åˆ° 1 é¡¹<b>å¼‚å¸¸é¢„è­¦</b>ï¼Œè¯·å…³æ³¨ã€‚";
                artifactHTML = `
                    <div class="card-header"><span style="font-weight:700;">ğŸ”” å®¶æ ¡äº’é€šæé†’</span></div>
                    <div class="card-body">
                        <div class="list-item">
                            <div>ğŸ“š <strong>å­¦ä¸šè¿›åº¦</strong></div>
                            <span style="color:#666">ç¬¬ 3 å•å…ƒï¼ˆå·²å®Œæˆ 80%ï¼‰</span>
                        </div>
                        <div class="list-item" style="background:#fef2f2;">
                            <div>âš ï¸ <strong>å¼‚å¸¸é¢„è­¦</strong></div>
                            <span style="color:#ef4444">è¿ç»­ 2 å¤©æœªæäº¤è‹±è¯­å£è¯­ä½œä¸š</span>
                        </div>
                        <div style="padding:15px; margin-top:10px; background:#f9fafb; border-radius:8px;">
                            <div style="font-size:12px; color:#666; margin-bottom:5px;">AI å»ºè®®æ²Ÿé€šè¯æœ¯ï¼š</div>
                            <div style="font-size:13px;">â€œå®è´ï¼Œæœ€è¿‘è‹±è¯­å£è¯­ç»ƒä¹ æ˜¯ä¸æ˜¯é‡åˆ°äº†ä»€ä¹ˆå›°éš¾ï¼Ÿéœ€è¦çˆ¸çˆ¸å¦ˆå¦ˆé™ªä½ ä¸€èµ·ç»ƒå—ï¼Ÿâ€</div>
                        </div>
                    </div>
                    <div class="card-actions"><button class="btn btn-primary">è”ç³»ç­ä¸»ä»»</button></div>`;
            }
            else if (type === 'parent_edu') {
                steps = ["åˆ†æå®¶é•¿è¾“å…¥ï¼šåŒå­¦æƒ…ç»ª", "åŒ¹é…å¿ƒç†å­¦æ¨¡å‹ï¼šå­¦ä¹ åŠ¨åŠ›ç¼ºå¤±", "æ£€ç´¢å®¶åº­æ•™è‚²çŸ¥è¯†åº“", "ç”Ÿæˆä¸ªæ€§åŒ–æŒ‡å¯¼æ–¹æ¡ˆ"];
                summary = "é’ˆå¯¹<b>â€œåŒå­¦æƒ…ç»ªâ€</b>ï¼Œå»ºè®®é‡‡ç”¨<b>â€œå…±æƒ…æ²Ÿé€šæ³•â€</b>ï¼Œå¹¶å…³æ³¨å­©å­æœ€è¿‘çš„å‹åŠ›æºã€‚";
                artifactHTML = `
                    <div class="card-header"><span style="font-weight:700; color:#059669">ğŸŒ± å®¶åº­æ•™è‚²æŒ‡å¯¼</span></div>
                    <div class="card-body">
                        <div class="list-item">
                            <div><strong>1. æ²Ÿé€šæŠ€å·§</strong><br><span style="font-size:12px; color:#666">å…ˆæ¥çº³æƒ…ç»ªï¼Œå†è¯´æ•™ã€‚å°è¯•è¯´ï¼šâ€œçœ‹ä½ æœ€è¿‘å¾ˆç´¯ï¼Œæ˜¯ä¸æ˜¯å­¦ä¹ å‹åŠ›å¤ªå¤§äº†ï¼Ÿâ€</span></div>
                        </div>
                        <div class="list-item">
                            <div><strong>2. æ¨èèµ„æº</strong><br><span style="font-size:12px; color:#10b981">ğŸ“– æ–‡ç« ï¼šã€Šå¦‚ä½•å¸®åŠ©é’æ˜¥æœŸå­©å­é‡æ‹¾å­¦ä¹ åŠ¨åŠ›ã€‹</span></div>
                        </div>
                        <div style="margin-top:10px; padding:10px; background:#ecfdf5; border-radius:8px; font-size:13px; color:#047857;">
                            ğŸ§  <strong>å¿ƒç†é”¦å›Šï¼š</strong> å¾ˆå¤šæ—¶å€™â€œåŒå­¦â€æ˜¯å¯¹â€œæŒ«è´¥æ„Ÿâ€çš„é˜²å¾¡ï¼Œå¤šç»™ä¸€äº›å¾®å°çš„æ­£å‘åé¦ˆã€‚
                        </div>
                    </div>`;
            }

            // ================== ADMIN ==================
            else if (type === 'admin_safety') {
                steps = ["è¿æ¥å®‰é˜²æ‘„åƒå¤´æµ", "è¿è¡Œäººè„¸è¯†åˆ«ç®—æ³•", "æ£€æµ‹åŒºåŸŸå…¥ä¾µè¡Œä¸º", "ç”Ÿæˆå®æ—¶è­¦æŠ¥"];
                summary = "å…¨æ ¡å®‰å…¨ç›‘æ§è¿è¡Œä¸­ã€‚å‘ç° <b>2 å¤„å¼‚å¸¸</b>ï¼Œå·²è‡ªåŠ¨æ ‡è®°ã€‚";
                artifactHTML = `
                    <div class="card-header"><span style="font-weight:700; color:#991b1b">ğŸ›¡ï¸ é£é™©é¢„è­¦ä¸­å¿ƒ</span><span class="tag tag-red">LIVE</span></div>
                    <div class="card-body">
                        <div class="alert-row">
                            <div>
                                <div style="font-weight:600; font-size:14px;">ä½“è‚²é¦†åé—¨æœªé”</div>
                                <div style="font-size:11px; color:#888;">å®‰é˜²ç³»ç»Ÿ Â· 16:32 æ£€æµ‹</div>
                            </div>
                            <span class="alert-badge bg-red">ä¸­é£é™©</span>
                        </div>
                        <div class="alert-row">
                            <div>
                                <div style="font-weight:600; font-size:14px;">æ ¡é—¨å£é™Œç”Ÿäººé€—ç•™</div>
                                <div style="font-size:11px; color:#888;">å®‰é˜²ç³»ç»Ÿ Â· 16:35 æ£€æµ‹</div>
                            </div>
                            <span class="alert-badge bg-red">é«˜é£é™©</span>
                        </div>
                        <div style="height:100px; background:#000; margin-top:10px; border-radius:8px; display:flex; align-items:center; justify-content:center; color:#fff; font-size:12px;">
                            [å®æ—¶ç›‘æ§ç”»é¢æµ - æ¨¡æ‹Ÿ]
                        </div>
                    </div>
                    <div class="card-actions"><button class="btn btn-primary" style="background:#ef4444; border-color:#ef4444;">ä¸€é”®é€šçŸ¥å®‰ä¿</button></div>`;
            }
            
else if (type === 'admin_activity') {
                const ana = APP_STATE.adminAnalytics || {};
                const focus = (ctx && ctx.focus) ? ctx.focus : "ä¸€æ¬¡å‡½æ•°æˆªè·";
                const series = (ana.weakPointTrend && ana.weakPointTrend[focus]) ? ana.weakPointTrend[focus] : [5,6,6,7,8,9,10];
                const cmp = (ana.classCompare || []);

                steps = [
                    "èšåˆå­¦æƒ…æ•°æ®ï¼ˆä½œä¸š/ç»ƒä¹ /è¯¾å ‚åé¦ˆï¼‰",
                    "æ›´æ–°è–„å¼±ç‚¹çƒ­åº¦è¶‹åŠ¿ï¼ˆ7å¤©ï¼‰",
                    "æŒ‰ç­çº§å¯¹æ¯”å®Œæˆç‡/æŒæ¡ç‡",
                    "ç”Ÿæˆæ²»ç†å»ºè®®ä¸ç£å¯¼åŠ¨ä½œï¼ˆå¯æ´¾å•ï¼‰"
                ];
                summary = `æ•™å­¦æ²»ç†çœ‹æ¿å·²æ›´æ–°ï¼šè–„å¼±ç‚¹ã€Œ<b>${focus}</b>ã€çƒ­åº¦ä¸Šå‡ï¼Œå»ºè®®å…³æ³¨ç­çº§å®Œæˆç‡ä¸æŒæ¡ç‡ã€‚`;

                artifactHTML = `
                    <div class="card-header">
                        <span style="font-weight:800;">ğŸ›ï¸ æ²»ç†é©¾é©¶èˆ± Â· å­¦æƒ…è·Ÿè¸ª</span>
                        <span style="font-size:11px; color:#6b7280;">${new Date().toLocaleDateString()}</span>
                    </div>
                    <div class="card-body">

                        <div class="stat-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr; margin-bottom:12px;">
                            <div class="stat-box"><div class="stat-val">${Math.round((cmp[2]?.completion||0.65)*100)}%</div><div class="stat-lbl">æœ¬å‘¨å®Œæˆç‡</div></div>
                            <div class="stat-box"><div class="stat-val">${Math.round((cmp[2]?.mastery||0.66)*100)}%</div><div class="stat-lbl">æœ¬å‘¨æŒæ¡ç‡</div></div>
                            <div class="stat-box"><div class="stat-val" style="color:#ef4444">${focus}</div><div class="stat-lbl">é‡ç‚¹è–„å¼±ç‚¹</div></div>
                            <div class="stat-box"><div class="stat-val">${Math.max(...series)}</div><div class="stat-lbl">çƒ­åº¦ï¼ˆ7å¤©ï¼‰</div></div>
                        </div>

                        <div style="display:grid; grid-template-columns: 1.15fr 0.85fr; gap:12px;">
                            <div style="border:1px solid #e5e7eb; background:#fff; border-radius:16px; padding:12px;">
                                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px;">
                                    <div style="font-weight:800;">è–„å¼±ç‚¹è¶‹åŠ¿ï¼ˆ7å¤©ï¼‰</div>
                                    <span class="tag tag-blue">é‡ç‚¹ï¼š${focus}</span>
                                </div>
                                <div style="margin:6px 0 10px;">${renderSparkline(series)}</div>
                                <div style="font-size:12px; color:#6b7280; line-height:1.4;">
                                    å£å¾„ï¼šçƒ­åº¦ = å‘½ä¸­è–„å¼±ç‚¹çš„ç»ƒä¹ /é”™é¢˜ä»»åŠ¡æ•°é‡ï¼ˆæ¨¡æ‹Ÿï¼‰ã€‚æ¨é€ä»»åŠ¡ä¼šæå‡çƒ­åº¦ï¼›å­¦ç”Ÿå®Œæˆå›ä¼ åï¼ŒæŒæ¡ç‡ä¼šä¸Šè°ƒã€‚
                                </div>
                            </div>

                            <div style="border:1px solid #e5e7eb; background:#fff; border-radius:16px; padding:12px;">
                                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px;">
                                    <div style="font-weight:800;">ç­çº§å¯¹æ¯”</div>
                                    <span class="tag tag-green">å¯ç£å¯¼</span>
                                </div>
                                <div style="max-height:180px; overflow:auto; border-radius:12px; border:1px solid #eef2f7;">
                                    <table style="width:100%; border-collapse:collapse; font-size:12px;">
                                        <thead>
                                            <tr style="background:#f9fafb; color:#6b7280;">
                                                <th style="text-align:left; padding:8px; border-bottom:1px solid #eef2f7;">ç­çº§</th>
                                                <th style="text-align:right; padding:8px; border-bottom:1px solid #eef2f7;">å®Œæˆç‡</th>
                                                <th style="text-align:right; padding:8px; border-bottom:1px solid #eef2f7;">æŒæ¡ç‡</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${cmp.map(row=>{
                                                const isFocus = row.className==="åˆäºŒ(3)ç­";
                                                return `
                                                    <tr style="background:${isFocus?"#fffbeb":"#fff"};">
                                                        <td style="padding:8px; border-bottom:1px solid #f3f4f6; font-weight:${isFocus?800:650};">${row.className}</td>
                                                        <td style="padding:8px; border-bottom:1px solid #f3f4f6; text-align:right;">${Math.round((row.completion||0)*100)}%</td>
                                                        <td style="padding:8px; border-bottom:1px solid #f3f4f6; text-align:right;">${Math.round((row.mastery||0)*100)}%</td>
                                                    </tr>
                                                `;
                                            }).join("")}
                                        </tbody>
                                    </table>
                                </div>

                                <div style="margin-top:10px; font-size:12px; color:#6b7280; line-height:1.4;">
                                    å»ºè®®åŠ¨ä½œï¼šå¯¹â€œå®Œæˆç‡ä½äº 65%â€ç­çº§å‘èµ·ç£å¯¼ï¼Œé‡ç‚¹å…³æ³¨è–„å¼±ç‚¹ã€Œ${focus}ã€çš„è®²è¯„ä¸åˆ†å±‚ä½œä¸šã€‚
                                </div>
                            </div>
                        </div>

                        <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
                            <button class="btn btn-primary" onclick="addMsg('EduCore','å·²ç”Ÿæˆç£å¯¼æ´¾å•ï¼ˆæ¨¡æ‹Ÿï¼‰ï¼šè¦æ±‚å„ç­æœ¬å‘¨å†…å®Œæˆè–„å¼±ç‚¹è®²è¯„ä¸äºŒæ¬¡ç»ƒä¹ ã€‚')">ç”Ÿæˆç£å¯¼æ´¾å•</button>
                            <button class="btn" style="border:1px solid #e5e7eb; background:#fff;" onclick="addMsg('EduCore','å·²ç”Ÿæˆç®€æŠ¥ï¼ˆæ¨¡æ‹Ÿï¼‰ï¼šè–„å¼±ç‚¹è¶‹åŠ¿ + ç­çº§å¯¹æ¯” + å»ºè®®åŠ¨ä½œã€‚')">å¯¼å‡ºç®€æŠ¥</button>
                        </div>
                    </div>`;
            }
else if (type === 'admin_canteen') {
                steps = ["èšåˆé£Ÿå ‚æ¶ˆè´¹æ•°æ®", "åˆ†æè¥å…»æ‘„å…¥æ¨¡å‹", "æŠ“å–æ»¡æ„åº¦è¯„ä»·å…³é”®è¯", "ç”Ÿæˆä¼˜åŒ–å»ºè®®"];
                summary = "æœ¬å‘¨é£Ÿå ‚è¿è¥æŠ¥å‘Šå·²ç”Ÿæˆã€‚<b>Bå¥—é¤ï¼ˆçº¢çƒ§è‚‰ï¼‰</b>æœ€å—æ¬¢è¿ï¼Œä½†<b>è”¬èœæ‘„å…¥é‡</b>æ•´ä½“åä½ã€‚";
                artifactHTML = `
                    <div class="card-header"><span style="font-weight:700;">ğŸ± é£Ÿå ‚æ™ºèƒ½ç®¡ç†</span></div>
                    <div class="card-body">
                        <div class="stat-grid">
                            <div class="stat-box"><div class="stat-val">Top1</div><div class="stat-lbl">çº¢çƒ§è‚‰å¥—é¤</div></div>
                            <div class="stat-box"><div class="stat-val" style="color:#ef4444">Low</div><div class="stat-lbl">ç»¿å¶èœæ‘„å…¥</div></div>
                            <div class="stat-box"><div class="stat-val">4.8</div><div class="stat-lbl">æ»¡æ„åº¦è¯„åˆ†</div></div>
                        </div>
                        <div class="list-item" style="margin-top:10px;">
                            <div><strong>ä¼˜åŒ–å»ºè®®ï¼š</strong> å¢åŠ â€œæ¸…ç‚’æ—¶è”¬â€ä½œä¸ºèµ é€å°èœï¼Œæå‡è†³é£Ÿçº¤ç»´æ‘„å…¥ã€‚</div>
                        </div>
                    </div>
                    <div class="card-actions"><button class="btn btn-primary">è°ƒæ•´ä¸‹å‘¨èœå•</button></div>`;
            }

            // --- æ¸²æŸ“è¿‡ç¨‹ ---
            for (let txt of steps) {
                const step = document.createElement('div');
                step.className = 'step active';
                step.innerHTML = `<i class="ri-loader-4-line spin"></i> ${txt}`;
                thinkBox.appendChild(step);
                scrollToBottom();
                await wait(800);
                step.className = 'step done';
                step.innerHTML = `<i class="ri-check-line"></i> ${txt}`;
            }

            // --- æ¸²æŸ“æœ€ç»ˆå¡ç‰‡ ---
            const finalCard = `
                <div class="artifact-card" style="border-left: 4px solid var(--theme-color)">
                    ${artifactHTML}
                </div>`;
            
            addMsg('EduCore', summary + finalCard);
        }

        function wait(ms) { return new Promise(r => setTimeout(r, ms)); }
        function scrollToBottom() { const cl = document.getElementById('chatLayer'); cl.scrollTop = cl.scrollHeight; }

    </script>

    <!-- é…ç½®æ¨é€å¼¹çª—ï¼ˆé“¾è·¯Aå¢å¼ºï¼šé€‰çŸ¥è¯†ç‚¹+é€‰å­¦ç”Ÿï¼‰ -->
    
<div class="modal-overlay" id="pushModal">
        <div class="modal">
            <div class="modal-hd">
                <div class="modal-title">é…ç½®å¹¶æ¨é€é”™é¢˜ç»ƒä¹ åŒ…</div>
                <button class="mini-btn" onclick="closePushModal()"><i class="ri-close-line"></i> å…³é—­</button>
            </div>
            <div class="modal-bd">
                <div style="font-size:12px; color:#6b7280; margin-bottom:10px;">
                    é€‰æ‹©æ¨é€ç»´åº¦ï¼ˆçŸ¥è¯†ç‚¹ / é”™å› æ ‡ç­¾ / é¢˜ç›®è®¢æ­£ï¼‰ä¸ç›®æ ‡å­¦ç”Ÿã€‚ç³»ç»Ÿå°†ç”Ÿæˆå­¦ç”Ÿç«¯å¾…åŠï¼Œå¹¶æºå¸¦æ•™å¸ˆä¸Šä¸‹æ–‡ï¼›å­¦ç”Ÿå®Œæˆåå¯å›ä¼ è€å¸ˆç”¨äºåˆ†å±‚å·©å›ºã€‚
                </div>

                <div class="seg-row">
                    <div class="seg" role="tablist" aria-label="push-mode">
                        <button id="pushMode_kp" class="seg-btn active" onclick="setPushMode('kp')">æŒ‰çŸ¥è¯†ç‚¹</button>
                        <button id="pushMode_tag" class="seg-btn" onclick="setPushMode('tag')">æŒ‰é”™å› æ ‡ç­¾</button>
                        <button id="pushMode_q" class="seg-btn" onclick="setPushMode('q')">æŒ‰é¢˜ç›®è®¢æ­£</button>
                    </div>
                    <div style="font-size:12px; color:#6b7280;">é»˜è®¤æ¨èæ¥è‡ªä½œä¸šæ´å¯Ÿï¼Œå¯å¤šé€‰ã€‚</div>
                </div>

                <div class="modal-grid">
                    <!-- å·¦ä¾§ï¼šæ¨é€å†…å®¹ -->
                    <div class="pick">
                        <div class="pick-h">
                            <span id="pickTitle">çŸ¥è¯†ç‚¹ï¼ˆå¯å¤šé€‰ï¼‰</span>
                            <button class="mini-btn" onclick="toggleAll(APP_STATE.pushMode || 'kp', true)">å…¨é€‰</button>
                        </div>

                        <div id="pick_kp">
                            <ul id="kpPickList"></ul>
                            <div style="margin-top:8px; font-size:12px; color:#6b7280;">å»ºè®®ï¼šä¼˜å…ˆæ¨é€â€œæ´å¯Ÿå‘½ä¸­â€çš„ 1 ä¸ªçŸ¥è¯†ç‚¹ï¼Œå†è¡¥å…… 1 ä¸ªæ‰©å±•ç‚¹ã€‚</div>
                        </div>

                        <div id="pick_tag" style="display:none;">
                            <ul id="tagPickList"></ul>
                            <div style="margin-top:8px; font-size:12px; color:#6b7280;">å»ºè®®ï¼šæŒ‰é”™å› æ ‡ç­¾æ¨é€ï¼Œæ›´è´´è¿‘â€œåˆ†å±‚çº é”™â€æ•™å­¦æ³•ã€‚</div>
                        </div>

                        <div id="pick_q" style="display:none;">
                            <ul id="qPickList"></ul>
                            <div style="margin-top:8px; font-size:12px; color:#6b7280;">å»ºè®®ï¼šæŒ‰é¢˜ç›®è®¢æ­£æ¨é€ï¼Œé€‚åˆå…³é”®é”™é¢˜â€œå½“å ‚æ¸…â€ã€‚</div>
                        </div>
                    </div>

                    <!-- å³ä¾§ï¼šé€‰æ‹©å­¦ç”Ÿ -->
                    <div class="pick">
                        <div class="pick-h">
                            <span>å­¦ç”Ÿï¼ˆå¯å¤šé€‰ï¼‰</span>
                            <div style="display:flex; gap:8px;">
                                <button class="mini-btn" onclick="toggleAll('stu', true)">å…¨é€‰</button>
                                <button class="mini-btn" onclick="toggleAll('stu', false)">æ¸…ç©º</button>
                            </div>
                        </div>
                        <ul id="stuPickList"></ul>
                        <div style="margin-top:8px; font-size:12px; color:#6b7280;">é»˜è®¤å‹¾é€‰ï¼šæ´å¯Ÿå…³æ³¨å­¦ç”Ÿï¼ˆé”™å› å‘½ä¸­æ›´é«˜ï¼‰ã€‚</div>
                    </div>
                </div>
            </div>

            <div class="modal-ft">
                <button class="btn-ghost" onclick="closePushModal()">å–æ¶ˆ</button>
                <button class="btn-solid" onclick="confirmPushModal()">ç¡®è®¤æ¨é€</button>
            </div>
        </div>
    </div>
</body>
</html>
